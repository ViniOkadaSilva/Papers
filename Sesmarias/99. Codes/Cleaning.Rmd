---
title: "Cleaning"
output: html_document
date: "2023-08-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading Up Packages

```{r}
rm(list = ls())

library(ggplot2)
library(ggspatial)
library(tidyr)
library(dplyr)
library(sf)
library(raster)
library(nngeo)
library(geobr)
library(terra)
library(readxl)
library(exactextractr)
library(modelsummary)
library(kableExtra)
library(stringr)
```

# Loading Up Data:

```{r}
mun_census_1872 <- read_municipality(code_muni = "all",year = 1872, simplified = TRUE, showProgress = TRUE)

setwd("~/OneDrive - University of Illinois - Urbana/Research Data/Brazil/Census 1872")
census_1872 <- read_xlsx("municipalities_1872_census.xlsx")
census_names_1872 <- read_xlsx("CensusToShapeNames.xlsx")

sugarcane <- 
  terra::rast("~/OneDrive - University of Illinois - Urbana/Research Data/FAO_GAEZ/sugarcane_lowinput_CO2.tiff")
```

# Cleaning Data:

```{r}
census_1872_clean <- merge(census_1872, census_names_1872, by = c("MunicId", "ProvId"))
```

```{r}
census_1872_clean$abbrev_state <- ""
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Alagoas","AL", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Amazonas","AM", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Bahia","BA", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Ceará", "CE", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Espírito Santo","ES", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Goyaz","GO", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Maranhão","MA", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Minas Geraes","MG", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Matto Grosso","MT", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Pará","PA", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Parahyba","PB", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Pernambuco","PE", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Piauhy","PI", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Paraná","PR", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Rio de Janeiro","RJ", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Rio Grande do Norte","RN", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Rio Grande do Sul","RS", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Santa Catharina","SC", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Sergipe","SE", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "São Paulo","SP", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Municipio Neutro ( Município da Corte)","RJ",
         census_1872_clean$abbrev_state)

### 
census_1872_clean$PrimeiroDeProvincia <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Municipio Neutro ( Município da Corte)",
         "Municipio Neutro",
         census_1872_clean$PrimeiroDeProvincia)
```

```{r}
clean_1872 <- merge(mun_census_1872, census_1872_clean, by = c("name_muni", "abbrev_state"))
```

```{r}
clean_1872$free_slave <- 
  100*clean_1872$SomaDeSOMA_E_Almas/(clean_1872$SomaDeSOMA_L_Almas + clean_1872$SomaDeSOMA_E_Almas)

clean_1872$literacy_rate <- 
  100*(clean_1872$`SomaDeSOMA_L_Sabem Ler e Escrever`/
         (clean_1872$SomaDeH_LIVRES_Almas + clean_1872$SomaDeM_LIVRES_Almas))

clean_1872$s_literacy_rate <-
  100*(clean_1872$`SomaDeSOMA_E_Sabem Ler e Escrever`/clean_1872$SomaDeSOMA_E_Almas)

clean_1872$farmers <-
  100*(clean_1872$SomaDeSOMA_G_Lavradores + clean_1872$SomaDeSOMA_G_Criadores)/(clean_1872$SomaDeSOMA_L_Almas + clean_1872$SomaDeSOMA_E_Almas)

clean_1872$farmers_slaves <-
  100*(clean_1872$SomaDeSOMA_E_Lavradores + clean_1872$SomaDeSOMA_E_Criadores)/(clean_1872$SomaDeSOMA_E_Almas)

clean_1872$industrial_workers <-
  100*(clean_1872$`SomaDeSOMA_G_Manufatureiros e fabricantes` + clean_1872$`SomaDeSOMA_G_Comerciantes, guarda-livros e caixeiros`)/(clean_1872$SomaDeSOMA_L_Almas + clean_1872$SomaDeSOMA_E_Almas)

clean_1872$gender_disparity <-
  (clean_1872$SomaDeH_LIVRES_Almas/clean_1872$SomaDeM_LIVRES_Almas)

clean_1872$slave_gender_disparity <-
  (clean_1872$SomaDeH_ESCR_Almas/clean_1872$SomaDeM_ESCR_Almas)

clean_1872$total_slaves <- clean_1872$SomaDeSOMA_E_Almas

clean_1872$men_farmers_prop <- 
  100*(clean_1872$SomaDeH_LIVRES_Lavradores + clean_1872$SomaDeH_LIVRES_Criadores)/clean_1872$SomaDeH_LIVRES_Almas

clean_1872$women_farmers_prop <- 
  100*(clean_1872$SomaDeM_LIVRES_Lavradores + clean_1872$SomaDeM_LIVRES_Criadores)/clean_1872$SomaDeM_LIVRES_Almas

#clean_1872$p_agriculture <-
#  100*(parishes_1872$SOMA_L_Agriculture/parishes_1872$SOMA_L_Almas)
```

# Generates Variables for the 1872 census

```{r}
sesmarias_pts <- read_xlsx("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Data/sesmarias_georeferenced.xlsx")

mun_1872 <- read_municipality(code_muni = "all",year = 1872, simplified = TRUE, showProgress = TRUE)
mun_2010 <- read_municipality(code_muni = "all",year = 2010, simplified = TRUE, showProgress = TRUE)

mun_2010$sugarcane <- exact_extract(sugarcane, mun_2010, 'mean', progress = FALSE)

sesmarias_pts$Latitude <- as.numeric(gsub('°','',sesmarias_pts$Latitude))
sesmarias_pts$Longitude <- as.numeric(gsub('°','',sesmarias_pts$Longitude))

sesmarias_pts <- subset(sesmarias_pts, 
                        is.na(sesmarias_pts$Latitude) == F & is.na(sesmarias_pts$Longitude) == F)
sesmarias_pts <- st_as_sf(sesmarias_pts, coords = c("Longitude", "Latitude"), 
                          crs = st_crs(mun_1872))

sesmarias_pts$Year <- as.numeric(str_sub(sesmarias_pts$`Data da concessão`, -4))
```

# Adding up geographical data (1872):

### Loads Up the data:

```{r}
# Rivers

rivers <- read_sf("~/OneDrive - University of Illinois - Urbana/Research/Projects/Amazon/infrastructure/rodoviario/Hidrovias.shp")
rivers <- st_transform(rivers, st_crs(mun_1872))

# Data for the coastline
coastline <- read_sf("~/OneDrive - University of Illinois - Urbana/Research Data/Brazil/Shapefiles/Coastline/brazil-coastline/brazil_coastline.shp")

coastline <- st_transform(coastline, st_crs(mun_1872))

# Getting mean elevation

elevation <- terra::rast("~/OneDrive - University of Illinois - Urbana/Research Data/Global/Elevation/DEM_geotiff/alwdgg.tif")

# Getting mean slope

slope <- terra::rast("~/OneDrive - University of Illinois - Urbana/Research Data/Global/Slope/slope_1KMmn_GMTEDmd.tif")

# Galor Suitability Index

csi_pre <- terra::rast("~/OneDrive - University of Illinois - Urbana/Research Data/Crop Suitability Index/pre1500OptCalories.tif")

raster::crs(csi_pre) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"

csi_post <- terra::rast("~/OneDrive - University of Illinois - Urbana/Research Data/Crop Suitability Index/post1500OptCalories.tif")

raster::crs(csi_post) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
```

### Extracts to 1872:

```{r}
# Sugarcane:
clean_1872$sugarcane <- exact_extract(sugarcane, clean_1872, 'mean', progress = FALSE)

# Distance to Rivers:

river_dist <- st_distance(clean_1872, rivers)
river_dist <- apply(river_dist, 1, FUN = min)/1000
clean_1872$river_dist  <- river_dist

# Distance to Coastline:

coast_dist <- st_distance(clean_1872, coastline)
coast_dist <- apply(coast_dist, 1, FUN = min)/1000
clean_1872$coast_dist <- coast_dist

# Mean Slope:

clean_1872$m_slope <- exact_extract(slope, clean_1872, 'mean', progress = FALSE)

# Mean Elevation:

clean_1872$m_elevation <- exact_extract(elevation, clean_1872, 'mean', progress = FALSE)

# Galor Suitability Index:

clean_1872$csi_pre <-exact_extract(csi_pre, clean_1872, 'mean', progress = FALSE)

clean_1872$csi_post <-exact_extract(csi_post, clean_1872, 'mean', progress = FALSE)

# Sesmaria + Intensity:

p <- st_intersects(clean_1872, sesmarias_pts)
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

clean_1872$sesmarias_presence <- unlist(p)

p <- st_intersects(clean_1872, sesmarias_pts)
p[lengths(p) > 0] <- lengths(p)
p[lengths(p) == 0] <- 0

clean_1872$sesmarias_intensity <- unlist(p)

# Sesmarias pre-1700

p <- st_intersects(clean_1872, subset(sesmarias_pts, Year < 1701))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

clean_1872$sesmarias_presence_1600 <- unlist(p)

# Sesmarias post-1700 

p <- st_intersects(clean_1872, subset(sesmarias_pts, Year > 1700))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

clean_1872$sesmarias_presence_1700 <- unlist(p)
```

### Extracting Data to the Sesmarias for balance table:

```{r}
# Sugarcane:
sesmarias_pts$sugarcane <- 
  terra::extract(sugarcane, sesmarias_pts, method = 'simple', ID = F)$sugarcane_lowinput_CO2

# Distance to Rivers:

river_dist <- st_distance(sesmarias_pts, rivers)
river_dist <- apply(river_dist, 1, FUN = min)/1000
sesmarias_pts$river_dist  <- river_dist

# Distance to Coastline:

coast_dist <- st_distance(sesmarias_pts, coastline)
coast_dist <- apply(coast_dist, 1, FUN = min)/1000
sesmarias_pts$coast_dist <- coast_dist

# Mean Slope:

sesmarias_pts$m_slope <- 
  terra::extract(slope, sesmarias_pts, method = 'simple', ID = F)$slope_1KMmn_GMTEDmd

# Mean Elevation:

sesmarias_pts$m_elevation <- 
  terra::extract(as.numeric(elevation), sesmarias_pts, method = 'simple', ID = F)$BinValues

# Galor Suitability Index:

sesmarias_pts$csi_pre <-
  terra::extract(csi_pre, sesmarias_pts, method = 'simple', ID = F)$pre1500OptCalories

sesmarias_pts$csi_post <-
  terra::extract(csi_post, sesmarias_pts, method = 'simple', ID = F)$post1500OptCalories
```

```{r}
ggplot() +
  geom_sf(data = clean_1872, aes(fill = free_slave)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  theme_bw()

ggplot() +
  geom_sf(data = clean_1872, aes(fill = sugarcane)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  theme_bw()
```

# Merge that to the database to get the sizes and other stuff:

-   Manually check the economic activities

```{r}


# 2010:

mun_2010_NE <- subset(mun_2010, abbrev_state %in% c("PB", "PE", "RN", "AL"))

p <- st_intersects(mun_2010_NE, sesmarias_pts)
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

mun_2010_NE$sesmarias_presence <- unlist(p)
```

```{r}
ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "CE")), 
          aes(fill = free_slave)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 0.25, color = "red") +
  coord_sf(ylim = c(-2,-15), xlim = c(-34,-45), expand = FALSE) + 
  labs(fill = "Proportion of Slaves \n to Total Population (%)") +
  theme_bw() +
  theme(#legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/slave_proportion.png")

ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "CE")), 
          aes(fill = sugarcane)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 0.25, color = "red") +
  coord_sf(ylim = c(-2,-15), xlim = c(-34,-45), expand = FALSE) + 
  labs(fill = "Maximum Sugar \n Cane Production") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/sugarcane_production.png")

ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "CE")), 
          aes(fill = farmers)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 0.25, color = "red") +
  coord_sf(ylim = c(-2,-15), xlim = c(-34,-45), expand = FALSE) + 
  labs(fill = "Proportion of \n Farmers to Pop.") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/farmers_share.png")

ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "CE")), 
          aes(fill = farmers_slaves)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 0.25, color = "red") +
  coord_sf(ylim = c(-2,-15), xlim = c(-34,-45), expand = FALSE) + 
  labs(fill = "Proportion of Slave \n Farmers to Slave Pop.") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/slave_farmers_share.png")

ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "CE")), 
          aes(fill = industrial_workers)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 0.25, color = "red") +
  coord_sf(ylim = c(-2,-15), xlim = c(-34,-45), expand = FALSE) + 
  labs(fill = "Proportion of Industry \n Workers Pop.") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/industry_share.png")

ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "CE")), 
          aes(fill = gender_disparity)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 0.25, color = "red") +
  coord_sf(ylim = c(-2,-15), xlim = c(-34,-45), expand = FALSE) + 
  labs(fill = "Ratio of Men \n to Women.") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/gender_ratio.png")

ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "CE")), 
          aes(fill = slave_gender_disparity)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 0.25, color = "red") +
  coord_sf(ylim = c(-2,-15), xlim = c(-34,-45), expand = FALSE) + 
  labs(fill = "Ratio of Slave Men \n to Women.") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/gender_ratio_slaves.png")

ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "CE")), 
          aes(fill = log(total_slaves))) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 0.25, color = "red") +
  coord_sf(ylim = c(-2,-15), xlim = c(-34,-45), expand = FALSE) + 
  labs(fill = "Log(Total Slaves)") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/total_slaves.png")
```

```{r}
ggplot(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "CE")), 
       aes(x = sugarcane, y = free_slave)) +
  geom_point(color = "black", fill = "red") +
  geom_smooth(method='lm') + 
  labs(y = "Percentage of Slaves to Total Population (%)", x = "Potential Sugarcane Production",
       title = "Relationship between Slavery and Sugarcane in Northeastern States - Brazil") +
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/sugarcane_slavery.png")

ggplot(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "CE")), 
       aes(x = sugarcane, y = literacy_rate)) +
  geom_point(color = "black", fill = "red") +
  geom_smooth(method='lm') + 
  labs(y = "Literacy Rate (%)", x = "Potential Sugarcane Production",
       title = "Relationship between Sugarcane and Literacy in Northeastern States - Brazil") +
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/sugarcane_literacy.png")

ggplot(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "CE")), 
       aes(x = free_slave, y = literacy_rate)) +
  geom_point(color = "black", fill = "red") +
  geom_smooth(method='lm') + 
  labs(y = "Literacy Rate (%)", x = "Percentage of Slaves to Total Population (%)",
       title = "Relationship between Slavery and Literacy in Northeastern States - Brazil") +
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/slavery_literacy.png")
```

```{r}
ggplot() +
  geom_sf(data = mun_2010, fill = "white") +
  geom_sf(data = subset(mun_2010, abbrev_state %in% c("PB", "PE", "RN", "AL", "CE")), fill = "lightblue") +
  geom_sf(data = sesmarias_pts, size = 0.25, color = "red") +
  coord_sf(ylim = c(-2,-15), xlim = c(-34,-45), expand = FALSE) + 
  theme_bw()
```

# Summary Tables:

```{r}

```

# Regressions:

```{r}
summary(lm_robust(sesmarias_presence ~ log(sugarcane), 
                  fixed_effects = ~abbrev_state, 
                  data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "CE"))))

summary(lm_robust(free_slave ~ sesmarias_intensity, 
                  fixed_effects = ~abbrev_state, 
                  data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "CE"))))
```

# 2010 Data:

```{r}
race2010 <- read_xlsx("~/OneDrive - University of Illinois - Urbana/Research Data/Brazil/Census 2010/race2010census_clean.xlsx")

gini_2010 <- 
  read.csv("~/OneDrive - University of Illinois - Urbana/Research Data/Brazil/DataSUS/Dados/GINI/ginibr_clean.csv")

gdp_2010 <- read_xlsx("~/OneDrive - University of Illinois - Urbana/Research/Projects/Amazon/gdp/GDP1999-2017.xlsx")

mun_2010 <- merge(race2010, mun_2010, by = c("code_muni"))
```

```{r}
ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "CE")), 
          aes(fill = free_slave)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 0.25, color = "red") +
  coord_sf(ylim = c(-2,-15), xlim = c(-34,-45), expand = FALSE) + 
  labs(fill = "Proportion of Slaves \n to Total Population (%)") +
  theme_bw()

ggplot() +
  geom_sf(data = mun_2010$geom, fill = "white") +
  geom_sf(data = subset(mun_2010,  abbrev_state %in% c("PB", "PE", "RN", "AL", "CE")), 
          aes(fill = Preta)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 0.25, color = "red") +
  coord_sf(ylim = c(-2,-15), xlim = c(-34,-45), expand = FALSE) + 
  theme_bw()
```

# Testing Balance

### 1872

```{r}
clean_1872$within <- 
  ifelse(clean_1872$sesmarias_presence > 0, 
         "At least 1 Land Grant", 
         "No Land Grants")

summary_1872 <- subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL"))

summary_1872 <- 
  summary_1872[c("within",
                 "river_dist",
                 "coast_dist",
                 "m_slope",
                 "m_elevation",
                 "sugarcane",
                 "csi_pre",
                 "csi_post",
                 "SomaDeSOMA_G_Almas",
                 "free_slave", 
                 "gender_disparity",
                 "slave_gender_disparity",
                 "industrial_workers", 
                 "farmers_slaves",
                 "farmers",
                 "men_farmers_prop",
                 "women_farmers_prop",
                 "literacy_rate")]

summary_1872 <- dplyr::rename(summary_1872, 
                              # Geographical:
                              "Distance to Nearest River (km)" = river_dist,
                              "Distance to the Coast (km)" = coast_dist,
                              "Mean Slope (m)" = m_slope,
                              "Mean Elevation (m)" = m_elevation,  
                              # Agricultural:
                              "Potential Sugarcane Output (FAO)" = sugarcane, 
                              "Maximum Calories Pre-1500 (Galor, 2016)" = csi_pre,
                              "Maximum Calories Post-1500 (Galor, 2016)" = csi_post,
                              # Demographics
                              "Total Population" = SomaDeSOMA_G_Almas,
                              "Enslaved Population as Total (%)" = free_slave, 
                              "Ratio of Free Men to Free Women" = gender_disparity,
                              "Ratio of Enslaved Men to Enslaved Women" = slave_gender_disparity,
                              # Laboe
                              "Proportion of Industrial Workers (%)" = industrial_workers, 
                              "Proportion of Farmers (%)" = farmers,
                              "Proportion of Enslaved People working in Farming (%)" = farmers_slaves,
                              "Proportion of Free Men Farmers (%)" = men_farmers_prop,
                              "Proportion of Free Women Farmers (%)" = women_farmers_prop,
                              # Human Capital:
                              "Literacy Rate (%)" = literacy_rate)


datasummary_balance(~within, summary_1872, 
                    output = 'latex',
                    title = "Summary Statistics for Municipalities in 1872",
                    align = 'lcccccc',
                    stars = c('*' = .1, '**' = .05, '***' = 0.1)) %>% 
                    # escape = FALSE) %>%
  group_rows("Geographical",1,4) %>%
  group_rows("Agriculture", 5,7) %>%
  group_rows("Demographics", 8,11)  %>%
  group_rows("Labor", 12,16) %>%
  group_rows("Human Capital", 17,17) %>%
  kable_styling(latex_options = c("scale_down","hold_position"), position = "center") %>%
  save_kable("~/OneDrive - University of Illinois - Urbana/Research/Projects/Sesmarias Brazil/Tables/summary_1872.pdf")
  
datasummary_balance(~within, summary_1872)
```

### Sesmarias Themselves pre-1700 and post- 1700

```{r}
sesmarias_pts$within <- 
  ifelse(sesmarias_pts$Year < 1700, 
         "Granted between 1624-1699", 
         "Granted between 1700-1750")

sesmarias_summary <- 
  sesmarias_pts[c("within",
                 "river_dist",
                 "coast_dist",
                 "m_slope",
                 "m_elevation",
                 "sugarcane",
                 "csi_pre",
                 "csi_post")]

sesmarias_summary <- dplyr::rename(sesmarias_summary, 
                              # Geographical:
                              "Distance to Nearest River (km)" = river_dist,
                              "Distance to the Coast (km)" = coast_dist,
                              "Mean Slope (m)" = m_slope,
                              "Mean Elevation (m)" = m_elevation,  
                              # Agricultural:
                              "Potential Sugarcane Output (FAO)" = sugarcane, 
                              "Maximum Calories Pre-1500 (Galor, 2016)" = csi_pre,
                              "Maximum Calories Post-1500 (Galor, 2016)" = csi_post)

datasummary_balance(~within, sesmarias_summary,
                    output = 'latex',
                    title = "Summary Statistics for the Land Grants",
                    align = 'lcccccc',
                    stars = c('*' = .1, '**' = .05, '***' = 0.1),
                    dinm_statistic = "std.error") %>%
    kable_styling(latex_options = c("scale_down","hold_position"), position = "center") %>%
  save_kable("~/OneDrive - University of Illinois - Urbana/Research/Projects/Sesmarias Brazil/Tables/summary_sesmarias.pdf")
```

# Regressions

```{r}
summary(lm_robust(sesmarias_presence ~ log(sugarcane+1),
                  fixed_effects = ~abbrev_state,
                  data = mun_2010_NE))
```
