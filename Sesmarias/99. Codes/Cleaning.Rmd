---
title: "Cleaning"
output: html_document
date: "2023-08-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading Up Packages

```{r}
# rm(list = ls())

library(ggplot2)
library(ggspatial)
library(tidyr)
library(dplyr)
library(sf)
library(raster)
library(nngeo)
library(geobr)
library(terra)
library(readxl)
library(exactextractr)
library(modelsummary)
library(kableExtra)
library(stringr)
library(plyr)
library(stringr)
library(gtools)
knitr::opts_chunk$set(echo = TRUE, fig.width = 7.29, fig.height =  4.51)
```

# Loading Up Data:

```{r}
mun_census_1872 <- 
  read_municipality(code_muni = "all",year = 1872, simplified = TRUE, showProgress = TRUE)

mun_seat_census_1872 <-
  read_municipal_seat(year = 1872,  showProgress = TRUE)

setwd("~/OneDrive - University of Illinois - Urbana/Research Data/Brazil/Census 1872")
census_1872 <- read_xlsx("municipalities_1872_census.xlsx")
census_names_1872 <- read_xlsx("CensusToShapeNames.xlsx")

sugarcane <- 
  terra::rast("~/OneDrive - University of Illinois - Urbana/Research Data/FAO_GAEZ/sugarcane_lowinput_CO2.tiff")
```

# Cleaning Data:

```{r}
census_1872_clean <- merge(census_1872, census_names_1872, by = c("MunicId", "ProvId"))
```

```{r}
census_1872_clean$abbrev_state <- ""
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Alagoas","AL", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Amazonas","AM", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Bahia","BA", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Ceará", "CE", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Espírito Santo","ES", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Goyaz","GO", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Maranhão","MA", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Minas Geraes","MG", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Matto Grosso","MT", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Pará","PA", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Parahyba","PB", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Pernambuco","PE", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Piauhy","PI", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Paraná","PR", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Rio de Janeiro","RJ", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Rio Grande do Norte","RN", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Rio Grande do Sul","RS", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Santa Catharina","SC", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Sergipe","SE", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "São Paulo","SP", census_1872_clean$abbrev_state)
census_1872_clean$abbrev_state <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Municipio Neutro ( Município da Corte)","RJ",
         census_1872_clean$abbrev_state)

### 
census_1872_clean$PrimeiroDeProvincia <- 
  ifelse(census_1872_clean$PrimeiroDeProvincia == "Municipio Neutro ( Município da Corte)",
         "Municipio Neutro",
         census_1872_clean$PrimeiroDeProvincia)
```

```{r}
clean_1872 <- merge(mun_census_1872, census_1872_clean, by = c("name_muni", "abbrev_state"))
```

```{r}
clean_1872$G_below_15 = 
  clean_1872$`SomaDeSOMA_G_1 mês` + clean_1872$`SomaDeSOMA_G_2 meses` +
  clean_1872$`SomaDeSOMA_G_3 meses` + clean_1872$`SomaDeSOMA_G_4 meses` +
  clean_1872$`SomaDeSOMA_G_5 meses` + clean_1872$`SomaDeSOMA_G_6 meses` +
  clean_1872$`SomaDeSOMA_G_7 meses` + clean_1872$`SomaDeSOMA_G_8 meses` +
  clean_1872$`SomaDeSOMA_G_9 meses` + clean_1872$`SomaDeSOMA_G_10 meses` +
  clean_1872$`SomaDeSOMA_G_11 meses` + clean_1872$`SomaDeSOMA_G_1 ano` +
  clean_1872$`SomaDeSOMA_G_2 anos` + clean_1872$`SomaDeSOMA_G_3 anos` +
  clean_1872$`SomaDeSOMA_G_4 anos` + clean_1872$`SomaDeSOMA_G_5 anos` +
  clean_1872$`SomaDeSOMA_G_6-10 anos` + clean_1872$`SomaDeSOMA_G_11-15 anos`

clean_1872$L_below_15 = 
  clean_1872$`SomaDeSOMA_L_1 mês` + clean_1872$`SomaDeSOMA_L_2 meses` +
  clean_1872$`SomaDeSOMA_L_3 meses` + clean_1872$`SomaDeSOMA_L_4 meses` +
  clean_1872$`SomaDeSOMA_L_5 meses` + clean_1872$`SomaDeSOMA_L_6 meses` +
  clean_1872$`SomaDeSOMA_L_7 meses` + clean_1872$`SomaDeSOMA_L_8 meses` +
  clean_1872$`SomaDeSOMA_L_9 meses` + clean_1872$`SomaDeSOMA_L_10 meses` +
  clean_1872$`SomaDeSOMA_L_11 meses` + clean_1872$`SomaDeSOMA_L_1 ano` +
  clean_1872$`SomaDeSOMA_L_2 anos` + clean_1872$`SomaDeSOMA_L_3 anos` +
  clean_1872$`SomaDeSOMA_L_4 anos` + clean_1872$`SomaDeSOMA_L_5 anos` +
  clean_1872$`SomaDeSOMA_L_6-10 anos` + clean_1872$`SomaDeSOMA_L_11-15 anos`

clean_1872$free_blacks_slave_ratio <- 
  clean_1872$SomaDeSOMA_L_Preto/clean_1872$SomaDeSOMA_E_Preto

clean_1872$free_slave <- 
  100*clean_1872$SomaDeSOMA_E_Almas/(clean_1872$SomaDeSOMA_L_Almas + clean_1872$SomaDeSOMA_E_Almas)

clean_1872$proportion_white <- 
  100*clean_1872$SomaDeSOMA_L_Branco/(clean_1872$SomaDeSOMA_L_Almas + clean_1872$SomaDeSOMA_E_Almas)

clean_1872$proportion_pardo <- 
  100*clean_1872$SomaDeSOMA_L_Pardo/(clean_1872$SomaDeSOMA_L_Almas + clean_1872$SomaDeSOMA_E_Almas)

clean_1872$proportion_caboclo <- 
  100*clean_1872$SomaDeSOMA_L_Caboclo/(clean_1872$SomaDeSOMA_L_Almas + clean_1872$SomaDeSOMA_E_Almas)

clean_1872$proportion_free_black <- 
  100*clean_1872$SomaDeSOMA_L_Preto/(clean_1872$SomaDeSOMA_L_Almas + clean_1872$SomaDeSOMA_E_Almas)

clean_1872$literacy_rate <- 
  100*(clean_1872$`SomaDeSOMA_L_Sabem Ler e Escrever`/
         (clean_1872$SomaDeSOMA_L_Almas - clean_1872$L_below_15))

clean_1872$s_literacy_rate <-
  100*(clean_1872$`SomaDeSOMA_E_Sabem Ler e Escrever`/clean_1872$SomaDeSOMA_E_Almas)

clean_1872$farmers <-
  100*(clean_1872$SomaDeSOMA_G_Lavradores + clean_1872$SomaDeSOMA_G_Criadores)/(clean_1872$SomaDeSOMA_L_Almas + clean_1872$SomaDeSOMA_E_Almas)

clean_1872$pasture_workers <-
  100*(clean_1872$SomaDeSOMA_G_Criadores)/(clean_1872$SomaDeSOMA_G_Almas - clean_1872$G_below_15) 

clean_1872$slave_pasture_workers <-
  100*(clean_1872$SomaDeSOMA_E_Criadores)/(clean_1872$SomaDeSOMA_G_Almas - clean_1872$G_below_15) 

clean_1872$farmers_slaves <-
  100*(clean_1872$SomaDeSOMA_E_Lavradores + clean_1872$SomaDeSOMA_E_Criadores)/(clean_1872$SomaDeSOMA_E_Almas)

clean_1872$men_farmers_slaves <-
  100*(clean_1872$SomaDeH_ESCR_Lavradores + clean_1872$SomaDeH_ESCR_Criadores)/(clean_1872$SomaDeH_ESCR_Almas)

clean_1872$women_farmers_slaves <-
  100*(clean_1872$SomaDeM_ESCR_Lavradores + clean_1872$SomaDeM_ESCR_Criadores)/(clean_1872$SomaDeM_ESCR_Almas)

clean_1872$industrial_workers <-
  100*(clean_1872$`SomaDeSOMA_G_Manufatureiros e fabricantes` + clean_1872$`SomaDeSOMA_G_Comerciantes, guarda-livros e caixeiros`)/(clean_1872$SomaDeSOMA_L_Almas + clean_1872$SomaDeSOMA_E_Almas)

clean_1872$gender_disparity <-
  (clean_1872$SomaDeH_LIVRES_Almas/clean_1872$SomaDeM_LIVRES_Almas)

clean_1872$slave_gender_disparity <-
  (clean_1872$SomaDeH_ESCR_Almas/clean_1872$SomaDeM_ESCR_Almas)

clean_1872$total_slaves <- clean_1872$SomaDeSOMA_E_Almas

clean_1872$men_farmers_prop <- 
  100*(clean_1872$SomaDeH_LIVRES_Lavradores + clean_1872$SomaDeH_LIVRES_Criadores)/clean_1872$SomaDeH_LIVRES_Almas

clean_1872$women_farmers_prop <- 
  100*(clean_1872$SomaDeM_LIVRES_Lavradores + clean_1872$SomaDeM_LIVRES_Criadores)/clean_1872$SomaDeM_LIVRES_Almas

clean_1872$domestic_service_slaves <- 
  100*(clean_1872$`SomaDeSOMA_E_Serviço doméstico`/clean_1872$SomaDeSOMA_E_Almas)

clean_1872$domestic_service_slaves_men <- 
  100*(clean_1872$`SomaDeH_ESCR_Serviço doméstico`/clean_1872$SomaDeH_ESCR_Almas)

clean_1872$domestic_service_slave_women <- 
  100*(clean_1872$`SomaDeM_ESCR_Serviço doméstico`/clean_1872$SomaDeM_ESCR_Almas)

#clean_1872$p_agriculture <-
#  100*(parishes_1872$SOMA_L_Agriculture/parishes_1872$SOMA_L_Almas)
```

# Generates Variables for the 1872 census

```{r}
training_data <- readxl::read_xlsx("/Users/vinicius/Downloads/database_training.xlsx")

training_data$year <- as.numeric(str_sub(training_data$`Data de petição`,-4,-1))

training_data$area <- 
  ifelse(training_data$Área > 100, 
         training_data$Área * 4.84 * 10^-6, 
         training_data$Área * 2304)

training_data <- training_data[,c(1,18,20)]

test <- 
  cbind(training_data[,c(1,2,3)], 
        str_split_fixed(training_data$Justificativas, ";", 13))

colnames(test)[1] <- "reference"
```

```{r}
justifications <- read_xlsx("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Data/justification.xlsx")

colnames(justifications)[1] <- "reference"

test_2 <- 
  cbind(justifications[,c(1)], 
        str_split_fixed(justifications$JUSTIFICATIVA, ";", 13))


test_3 = 
test_2 %>%
  full_join(test, by = intersect(colnames(test_2), colnames(test))) %>%
  group_by(reference) 
```

```{r}
sesmarias_pts <- read_xlsx("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Data/sesmarias_georeferenced.xlsx")

sesmarias_pts$Year <- as.numeric(str_sub(sesmarias_pts$`Data da concessão`, -4))

colnames(sesmarias_pts)[1] <- "reference"

sesmarias_pts$reference <- str_replace_all(sesmarias_pts$reference, pattern=" ", repl="")

sesmarias_pts_PE <- subset(sesmarias_pts, 
                           grepl("PE", sesmarias_pts$reference) == TRUE |
                             grepl("IT", sesmarias_pts$reference) == TRUE)

# 0065, 0088, 0384, and 0385 are on the old database.

sesmarias_pts_PE <- merge(sesmarias_pts_PE, test_3, by = c("reference"), all.x = TRUE)

justifications_PB_RN <- 
  read_xlsx("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Data/justifications_PB.xlsx", "Justificativas e Exigencias")

sesmarias_pts_PB_RN <- subset(sesmarias_pts, 
                              grepl("PE", sesmarias_pts$reference) == FALSE &
                                grepl("IT", sesmarias_pts$reference) == FALSE)


colnames(justifications_PB_RN)[1] <- "reference"
justifications_PB_RN <- justifications_PB_RN[,c(1,2)]

justifications_PB_RN$reference <- 
  str_replace_all(justifications_PB_RN$reference, pattern=" ", repl="")

justifications_PB_RN <- justifications_PB_RN[!duplicated(justifications_PB_RN),]

test_4 <- 
  justifications_PB_RN %>% 
  group_by(reference) %>%
  dplyr::mutate(id_rows = row_number()) %>%
  pivot_wider( 
    id_cols = c(reference),
    names_from = id_rows,
    values_from = Justificativa) %>% 
  ungroup()

test_4 <- 
  subset(test_4, 
         grepl("PB", test_4$reference) == TRUE |
           grepl("RN", test_4$reference) == TRUE)

sesmarias_pts_PB_RN <- merge(sesmarias_pts_PB_RN, test_4, by = c("reference"), all.x = TRUE)

sesmarias_pts <- plyr::rbind.fill(sesmarias_pts_PE, sesmarias_pts_PB_RN)

sesmarias_pts <- sesmarias_pts[mixedsort(colnames(sesmarias_pts))]

sesmarias_pts <- sesmarias_pts[c(26,27, 23,25, seq(1,20,1))]
```

```{r}
mun_1872 <- read_municipality(code_muni = "all",year = 1872, simplified = TRUE, showProgress = TRUE)
mun_2010 <- read_municipality(code_muni = "all",year = 2010, simplified = TRUE, showProgress = TRUE)

mun_2010$sugarcane <- exact_extract(sugarcane, mun_2010, 'mean', progress = FALSE)

sesmarias_pts$Latitude <- as.numeric(gsub('°','',sesmarias_pts$Latitude))
sesmarias_pts$Longitude <- as.numeric(gsub('°','',sesmarias_pts$Longitude))

sesmarias_pts <- subset(sesmarias_pts, 
                        is.na(sesmarias_pts$Latitude) == F & 
                          is.na(sesmarias_pts$Longitude) == F)

sesmarias_pts <- st_as_sf(sesmarias_pts, coords = c("Longitude", "Latitude"), 
                          crs = st_crs(mun_1872))

# sesmarias_pts$Year <- as.numeric(str_sub(sesmarias_pts$`Data da concessão`, -4))
```

# Generating Types of Grants:

```{r}
p = data.frame()

for (i in seq(3,22,1))
{k = unique(st_drop_geometry(sesmarias_pts[i]))
colnames(k) <- "request"
p = rbind(p,k)}

p$request <- str_trim(p$request, side = c("both"))

p = unique(p)
```

# Adding up geographical data (1872):

### Loads Up the data:

```{r}
# Rivers

rivers <- read_sf("~/OneDrive - University of Illinois - Urbana/Research/Projects/Amazon/infrastructure/rodoviario/Hidrovias.shp")
rivers <- st_transform(rivers, st_crs(mun_1872))

# Data for the coastline
coastline <- geobr::read_biomes(year = 2019)

coastline <- subset(coastline, name_biome == "Sistema Costeiro")

coastline <- st_transform(coastline, st_crs(mun_1872))

# Getting mean elevation

elevation <- terra::rast("~/OneDrive - University of Illinois - Urbana/Research Data/Global/Elevation/DEM_geotiff/alwdgg.tif")

# Getting mean slope

slope <- terra::rast("~/OneDrive - University of Illinois - Urbana/Research Data/Global/Slope/slope_1KMmn_GMTEDmd.tif")

# Galor Suitability Index

csi_pre <- terra::rast("~/OneDrive - University of Illinois - Urbana/Research Data/Crop Suitability Index/pre1500OptCalories.tif")

raster::crs(csi_pre) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"

csi_post <- terra::rast("~/OneDrive - University of Illinois - Urbana/Research Data/Crop Suitability Index/post1500OptCalories.tif")

raster::crs(csi_post) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"

# MapBiomas (1990)

land_usage_2000 <- terra::rast("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research Data/Brazil/Mapbiomas/brasil_coverage_2000.tif")

raster::crs(land_usage_2000) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"

# ok this works:

```

### Extracts to 1872:

```{r}
# Sugarcane:
clean_1872$sugarcane <- exact_extract(sugarcane, clean_1872, 'mean', progress = FALSE)

# Distance to Rivers:

river_dist <- st_distance(clean_1872, rivers)
river_dist <- apply(river_dist, 1, FUN = min)/1000
clean_1872$river_dist  <- river_dist

# Distance to Coastline:

coast_dist <- st_distance(clean_1872, coastline)
coast_dist <- apply(coast_dist, 1, FUN = min)/1000
clean_1872$coast_dist <- coast_dist

# Distance from Municipality seat to coastline:

coast_dist <- st_distance(mun_seat_census_1872, coastline)
coast_dist <- apply(coast_dist, 1, FUN = min)/1000
mun_seat_census_1872$coast_dist_seat <- coast_dist

placeholder <- 
  st_drop_geometry(
  mun_seat_census_1872[c("code_muni", "abbrev_state", "coast_dist_seat")])

clean_1872 <- merge(clean_1872, placeholder, by = c("code_muni", "abbrev_state"))


# Mean Slope:

clean_1872$m_slope <- exact_extract(slope, clean_1872, 'mean', progress = FALSE)

# Mean Elevation:

clean_1872$m_elevation <- exact_extract(elevation, clean_1872, 'mean', progress = FALSE)

# Galor Suitability Index:

clean_1872$csi_pre <-exact_extract(csi_pre, clean_1872, 'mean', progress = FALSE)

clean_1872$csi_post <-exact_extract(csi_post, clean_1872, 'mean', progress = FALSE)

# Latitude and longitude 

# Sesmaria + Intensity:

p <- st_intersects(clean_1872, sesmarias_pts)
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

clean_1872$sesmarias_presence <- unlist(p)

p <- st_intersects(clean_1872, sesmarias_pts)
p[lengths(p) > 0] <- lengths(p)
p[lengths(p) == 0] <- 0

clean_1872$sesmarias_intensity <- unlist(p)

# Sesmarias pre-1700

p <- st_intersects(clean_1872, subset(sesmarias_pts, Year < 1697))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

clean_1872$sesmarias_presence_1600 <- unlist(p)

# Sesmarias post-1700 

p <- st_intersects(clean_1872, subset(sesmarias_pts, Year >= 1697))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

clean_1872$sesmarias_presence_1700 <- unlist(p)
```

```{r}
ggplot() +
    geom_sf(data = coastline)
```

### Economic Activity

```{r}
sesmarias_pts$sugar =
  ifelse((rowSums(sapply(sesmarias_pts, function(i) grepl("engenho|canaviais", i))) > 0), 1,0)

sesmarias_pts$pasture =
  ifelse((rowSums(sapply(sesmarias_pts, function(i) grepl("gado", i))) > 0), 1,0)

sesmarias_pts$discovery =
  ifelse((rowSums(sapply(sesmarias_pts, function(i) grepl("descobridor", i))) > 0), 1,0)

sesmarias_pts$settlement =
  ifelse((rowSums(sapply(sesmarias_pts, function(i) grepl("povoamento", i))) > 0), 1,0)

sesmarias_pts$no_land =
  ifelse((rowSums(sapply(sesmarias_pts, function(i) grepl("Não tinha terras", i))) > 0), 1,0)

sesmarias_pts$cattle_raising =
  ifelse((rowSums(sapply(sesmarias_pts, function(i) grepl("Pretendia criar gado|Pretendia fazer curral|Pretendia apascentar gado|Pretendia fazer curral|Pretendia ter criações|Pretendia apascentar criações|Pretendia aumentar sua criação de gado", i))) > 0), 1,0)

```

```{r}
# Sesmarias Sugar 

p <- st_intersects(clean_1872, subset(sesmarias_pts, sugar == 1))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

clean_1872$sugar <- unlist(p)

# Sesmarias Pasture

p <- st_intersects(clean_1872, subset(sesmarias_pts, pasture == 1))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

clean_1872$pasture <- unlist(p)

# Sesmarias Discovery

p <- st_intersects(clean_1872, subset(sesmarias_pts, discovery == 1))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

clean_1872$discovery <- unlist(p)

# Sesmarias Settlement

p <- st_intersects(clean_1872, subset(sesmarias_pts, settlement == 1))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

clean_1872$settlement <- unlist(p)

# Sesmarias No Land

p <- st_intersects(clean_1872, subset(sesmarias_pts, no_land == 1))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

clean_1872$no_land <- unlist(p)

# Specific Cattle Raising 

p <- st_intersects(clean_1872, subset(sesmarias_pts, cattle_raising == 1))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

clean_1872$cattle_raising <- unlist(p)

# Specific Cattle Raising Post 1701

p <- st_intersects(clean_1872, subset(sesmarias_pts, cattle_raising == 1 & Year > 1701))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

clean_1872$cattle_raising_post_1701 <- unlist(p)

```

# Extracting for 2010:

```{r}
mun_2010_NE = subset(mun_2010, abbrev_state %in% c("PB", "PE", "RN", "AL"))

# Sugarcane
mun_2010_NE$sugarcane <- exact_extract(sugarcane, mun_2010_NE, 'mean', progress = FALSE)

# River Distance

river_dist <- st_distance(mun_2010_NE, rivers)
river_dist <- apply(river_dist, 1, FUN = min)/1000
mun_2010_NE$river_dist  <- river_dist

# Distance to Coastline:

coast_dist <- st_distance(mun_2010_NE, coastline)
coast_dist <- apply(coast_dist, 1, FUN = min)/1000
mun_2010_NE$coast_dist <- coast_dist

# Mean Slope:

mun_2010_NE$m_slope <- exact_extract(slope, mun_2010_NE, 'mean', progress = FALSE)

# Mean Elevation:

mun_2010_NE$m_elevation <- exact_extract(elevation, mun_2010_NE, 'mean', progress = FALSE)

# Galor Suitability Index:

mun_2010_NE$csi_pre <-exact_extract(csi_pre, mun_2010_NE, 'mean', progress = FALSE)

mun_2010_NE$csi_post <-exact_extract(csi_post, mun_2010_NE, 'mean', progress = FALSE)

# Land Usage 1985

mun_2010_NE <- cbind(mun_2010_NE, 
                         exact_extract(land_usage_2000, mun_2010_NE, 'frac', progress = TRUE))

```

```{r}
# Sesmaria + Intensity:

p <- st_intersects(mun_2010_NE, sesmarias_pts)
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

mun_2010_NE$sesmarias_presence <- unlist(p)

p <- st_intersects(mun_2010_NE, sesmarias_pts)
p[lengths(p) > 0] <- lengths(p)
p[lengths(p) == 0] <- 0

mun_2010_NE$sesmarias_intensity <- unlist(p)

# Sesmarias pre-1700

p <- st_intersects(mun_2010_NE, subset(sesmarias_pts, Year < 1697))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

mun_2010_NE$sesmarias_presence_1600 <- unlist(p)

# Sesmarias post-1700 

p <- st_intersects(mun_2010_NE, subset(sesmarias_pts, Year >= 1697))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

mun_2010_NE$sesmarias_presence_1700 <- unlist(p)
```

```{r}
# Sesmarias Sugar 

p <- st_intersects(mun_2010_NE, subset(sesmarias_pts, sugar == 1))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

mun_2010_NE$sugar <- unlist(p)

# Sesmarias Pasture

p <- st_intersects(mun_2010_NE, subset(sesmarias_pts, pasture == 1))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

mun_2010_NE$pasture <- unlist(p)

# Sesmarias Discovery

p <- st_intersects(mun_2010_NE, subset(sesmarias_pts, discovery == 1))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

mun_2010_NE$discovery <- unlist(p)

# Sesmarias Settlement

p <- st_intersects(mun_2010_NE, subset(sesmarias_pts, settlement == 1))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

mun_2010_NE$settlement <- unlist(p)

# Sesmarias No Land

p <- st_intersects(mun_2010_NE, subset(sesmarias_pts, no_land == 1))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

mun_2010_NE$no_land <- unlist(p)

# Specific Cattle Raising 

p <- st_intersects(mun_2010_NE, subset(sesmarias_pts, cattle_raising == 1))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

mun_2010_NE$cattle_raising <- unlist(p)

# Specific Cattle Raising Post 1701

p <- st_intersects(mun_2010_NE, subset(sesmarias_pts, cattle_raising == 1 & Year > 1701))
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

mun_2010_NE$cattle_raising_post_1701 <- unlist(p)
```

# Extracting Data to the Sesmarias for balance table:

```{r}
# Sugarcane:
sesmarias_pts$sugarcane <- 
  terra::extract(sugarcane, sesmarias_pts, method = 'simple', ID = F)$sugarcane_lowinput_CO2

# Distance to Rivers:

river_dist <- st_distance(sesmarias_pts, rivers)
river_dist <- apply(river_dist, 1, FUN = min)/1000
sesmarias_pts$river_dist  <- river_dist

# Distance to Coastline:

coast_dist <- st_distance(sesmarias_pts, coastline)
coast_dist <- apply(coast_dist, 1, FUN = min)/1000
sesmarias_pts$coast_dist <- coast_dist

# Mean Slope:

sesmarias_pts$m_slope <- 
  terra::extract(slope, sesmarias_pts, method = 'simple', ID = F)$slope_1KMmn_GMTEDmd

# Mean Elevation:

sesmarias_pts$m_elevation <- 
  terra::extract(as.numeric(elevation), sesmarias_pts, method = 'simple', ID = F)$BinValues

# Galor Suitability Index:

sesmarias_pts$csi_pre <-
  terra::extract(csi_pre, sesmarias_pts, method = 'simple', ID = F)$pre1500OptCalories

sesmarias_pts$csi_post <-
  terra::extract(csi_post, sesmarias_pts, method = 'simple', ID = F)$post1500OptCalories
```

```{r}
ggplot() +
  geom_sf(data = clean_1872, aes(fill = free_slave)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  theme_bw()

ggplot() +
  geom_sf(data = clean_1872, aes(fill = sugarcane)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  theme_bw()
```

# Merge that to the database to get the sizes and other stuff:

-   Manually check the economic activities

```{r, eval = FALSE}
# 2010:

mun_2010_NE <- subset(mun_2010, abbrev_state %in% c("PB", "PE", "RN", "AL"))

p <- st_intersects(mun_2010_NE, sesmarias_pts)
p[lengths(p) > 0] <- 1
p[lengths(p) == 0] <- 0

mun_2010_NE$sesmarias_presence <- unlist(p)
```

```{r}
ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), aes(fill = free_slave)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 1, 
          color = "black",
          shape = 21, fill = "red") +
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(fill = "Proportion of Slaves \n to Total Population (%)") +
  theme_bw() +
  theme(#legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/slave_proportion.png")

ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
          aes(fill = sugarcane)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 1, 
          color = "black",
          shape = 21, fill = "red") +
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(fill = "Maximum Sugar \n Cane Production") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/sugarcane_production.png")

ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
          aes(fill = farmers)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 1, 
          color = "black",
          shape = 21, fill = "red") +
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(fill = "Proportion of \n Farmers to Pop.") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/farmers_share.png")

ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
          aes(fill = farmers_slaves)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 1, 
          color = "black",
          shape = 21, fill = "red") +
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(fill = "Proportion of Slave \n Farmers to Slave Pop.") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/slave_farmers_share.png")

ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
          aes(fill = industrial_workers)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 1, 
          color = "black",
          shape = 21, fill = "red") +
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(fill = "Proportion of Industry \n Workers Pop.") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/industry_share.png")

ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
          aes(fill = pasture_workers)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 1, 
          color = "black",
          shape = 21, fill = "red") +
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(fill = "Proportion of Ranching \n Workers") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))

ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
          aes(fill = gender_disparity)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 1, 
          color = "black",
          shape = 21, fill = "red") +
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(fill = "Ratio of Men \n to Women.") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/gender_ratio.png")

ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
          aes(fill = slave_gender_disparity)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 1, 
          color = "black",
          shape = 21, fill = "red") +
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(fill = "Ratio of Slave Men \n to Women.") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/gender_ratio_slaves.png")

ggplot() +
  #geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  
                        abbrev_state %in% c("PB", "PE", "RN", "AL", "MG", "SP", "BA")), 
          aes(fill = log(total_slaves))) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  #geom_sf(data = sesmarias_pts, size = 1, 
  #        color = "black",
  #        shape = 21, fill = "red") +
  #coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(fill = "Log(Total Slaves)") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/total_slaves.png")
```

# RDD - all in one

```{r}
clean_1872$ten_leagues_seat <- 
  ifelse(clean_1872$coast_dist_seat >= 80, 1, 0)

clean_1872$ten_leagues <- 
  ifelse(clean_1872$coast_dist >= 80, 1, 0)

# "SE", "CE", "ES", "RJ"

ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  
                        abbrev_state %in% c("PB", "PE", "RN", "AL", "MG", "SP", "BA")), 
          aes(fill = factor(ten_leagues))) +
  #geom_sf(data = mun_seat_census_1872, size = 0.1) +
  coord_sf(ylim = c(-30,-0), xlim = c(-34,-55), expand = FALSE) + 
  labs(fill = "80 km away of the coast:") +
  theme_bw() +
  theme(legend.position = "bottom")
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/coastal_dist_1872.png")

ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  
                        abbrev_state %in% 
                          c("PB", "PE", "RN", "AL", "MG","PI", "SE",
                            "SP", "BA", "CE", "MA", "ES", "RJ")), 
          aes(fill = factor(ten_leagues_seat))) +
  geom_sf(data = coastline) +
  coord_sf(ylim = c(-30,-0), xlim = c(-34,-55), expand = FALSE) + 
  labs(fill = "80 km away of the coast:") +
  theme_bw() +
  theme(legend.position = "bottom")


ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  
                        abbrev_state %in% 
                          c("PB", "PE", "RN", "AL", "MG","PI", "SE",
                            "SP", "BA", "CE", "MA", "ES", "RJ")), 
          aes(fill = factor(ten_leagues))) +
  geom_sf(data = coastline) +
  coord_sf(ylim = c(-30,-0), xlim = c(-34,-55), expand = FALSE) + 
  labs(fill = "80 km away of the coast:") +
  theme_bw() +
  theme(legend.position = "bottom")
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/coastal_dist_seat_1872.png.png")
```

```{r}
gm <- tibble::tribble(~raw,        ~clean,          ~fmt,
                      "nobs",      "N",             0,
                      "r.squared", "$R^2$", 2)

rows_se <-  tribble(~term, ~'(1)', ~'(2)', ~'(3)', ~'(4)', ~'(5)', 
                      'Polynomial Order', '1', '2', '1', '1', '1')

attr(rows_se, 'section') <- c('top')
attr(rows_se, 'position') <- c(3,4)



clean_1872$pasture_post_1700 <- ifelse(clean_1872$sesmarias_presence_1700 == 1 & clean_1872$pasture == 1, 1, 0)
clean_1872$pasture_pre_1700 <- ifelse(clean_1872$sesmarias_presence_1700 == 0 & clean_1872$pasture == 1, 1, 0)
clean_1872_NE <- subset(clean_1872,  
                        abbrev_state %in% 
                          c("PB", "PE", "RN", "AL", "MG","PI", "SE",
                            "SP", "BA", "CE", "MA", "ES", "RJ"))
clean_1872_NE$past_ten_leagues <- ifelse(clean_1872_NE$coast_dist > 80 , 1 ,0)


free_slave_ratio <-
rdd_data(y = free_slave, 
         x = coast_dist_seat, 
         covar = abbrev_state,
         data = clean_1872_NE,
         cutpoint = 80) 

bw_ik <- rdd_bw_ik(free_slave_ratio, kernel = "Triangular")

reg_1 <- 
  rdd_reg_lm(free_slave_ratio, 
             slope = "separate", 
             order = 1, 
             covariates = abbrev_state,
             bw = bw_ik) 

reg_2 <- 
  rdd_reg_lm(free_slave_ratio, slope = "separate", order = 2, bw = bw_ik) 

reg_3 <- 
  rdd_reg_lm(free_slave_ratio, slope = "separate", order = 1, bw = 70) 

reg_4 <- 
  rdd_reg_lm(free_slave_ratio, slope = "separate", order = 1, bw = 60) 

reg_5 <- 
  rdd_reg_lm(free_slave_ratio, slope = "separate", order = 1, bw = 50) 

sub("(\\\\midrule.*?)\\\\midrule", "\\1",
modelsummary(list("(1)" = reg_1, 
                  "(2)" = reg_2,
                  "(3)" = reg_3,
                  "(4)" = reg_4,
                  "(5)" = reg_5), 
             output = 'latex',
             coef_map = c("D" = "Estimate"), 
             gof_omit = 'R2 Adj.|se_type', 
             stars = c('*' = .1, '**' = 0.05, '***' = 0.01 ),
             add_rows = rows_se,
             gof_map = gm,
             escape = FALSE,
             title = "Effects on Proportion of Slaves to Total Population (\\%) \\label{tab:rdd_free_slave}") %>%
  add_header_above(c("",
                     "Optimal Bandwidth" = 2, 
                     "[10, 150]" = 1, 
                     "[20, 140]" = 1,
                     "[30, 130]" = 1)) %>%
  kable_styling(latex_options = c("hold_position")) %>%
  kableExtra::footnote(alphabet = "Mean of the dependent variable is 14.2%", threeparttable = T) %>%
  row_spec(2, hline_after = TRUE)) %>% 
    save_kable("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Writing/git/Sesmarias/04.Tables/v1/rdd_free_slave_1872.tex")
```

```{r}
farmers_slaves <-
    rdd_data(y = farmers_slaves, 
             x = coast_dist_seat, 
         covar = abbrev_state,
         data = clean_1872_NE,
         cutpoint = 80) 

bw_ik <- rdd_bw_ik(farmers_slaves, kernel = "Triangular")

reg_1 <- 
  rdd_reg_lm(farmers_slaves, slope = "separate", order = 1, bw = bw_ik) 

reg_2 <- 
  rdd_reg_lm(farmers_slaves, slope = "separate", order = 2, bw = bw_ik) 

reg_3 <- 
  rdd_reg_lm(farmers_slaves, slope = "separate", order = 1, bw = 70) 

reg_4 <- 
  rdd_reg_lm(farmers_slaves, slope = "separate", order = 1, bw = 60) 

reg_5 <- 
  rdd_reg_lm(farmers_slaves, slope = "separate", order = 1, bw = 50) 

sub("(\\\\midrule.*?)\\\\midrule", "\\1",
modelsummary(list("(1)" = reg_1, 
                  "(2)" = reg_2,
                  "(3)" = reg_3,
                  "(4)" = reg_4,
                  "(5)" = reg_5), 
             output = 'latex',
             coef_map = c("D" = "Estimate"), 
             gof_omit = 'R2 Adj.|se_type', 
             stars = c('*' = .1, '**' = 0.05, '***' = 0.01 ),
             add_rows = rows_se,
             gof_map = gm,
             escape = FALSE,
             title = "Effects on Proportion of Slaves Working in Farming (\\%) \\label{tab:rdd_enslaved_farming}") %>%
  add_header_above(c("",
                     "Optimal Bandwidth" = 2, 
                     "[10, 150]" = 1, 
                     "[20, 140]" = 1,
                     "[30, 130]" = 1)) %>%
  kable_styling(latex_options = c("hold_position")) %>%
  kableExtra::footnote(alphabet = "Mean of the dependent variable is 40.7%", threeparttable = T) %>%
  row_spec(2, hline_after = TRUE)) %>% 
    save_kable("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Writing/git/Sesmarias/04.Tables/v1/rdd_enslaved_farming_1872.tex")
```

```{r}
men_farmers_slaves <-
    rdd_data(y = clean_1872_NE$men_farmers_slaves, 
             x = clean_1872_NE$coast_dist_seat, 
             cutpoint = 80) 

bw_ik <- rdd_bw_ik(men_farmers_slaves, kernel = "Triangular")

reg_1 <- 
  rdd_reg_lm(men_farmers_slaves, slope = "separate", order = 1, bw = bw_ik) 

reg_2 <- 
  rdd_reg_lm(men_farmers_slaves, slope = "separate", order = 2, bw = bw_ik) 

reg_3 <- 
  rdd_reg_lm(men_farmers_slaves, slope = "separate", order = 1, bw = 70) 

reg_4 <- 
  rdd_reg_lm(men_farmers_slaves, slope = "separate", order = 1, bw = 60) 

reg_5 <- 
  rdd_reg_lm(men_farmers_slaves, slope = "separate", order = 1, bw = 50) 

sub("(\\\\midrule.*?)\\\\midrule", "\\1",
modelsummary(list("(1)" = reg_1, 
                  "(2)" = reg_2,
                  "(3)" = reg_3,
                  "(4)" = reg_4,
                  "(5)" = reg_5), 
             output = 'latex',
             coef_map = c("D" = "Estimate"), 
             gof_omit = 'R2 Adj.|se_type', 
             stars = c('*' = .1, '**' = 0.05, '***' = 0.01 ),
             add_rows = rows_se,
             gof_map = gm,
             escape = FALSE,
             title = "Effects on Proportion of Male Slaves Working in Farming (\\%) \\label{tab:rdd_men_enslaved_farming}") %>%
  add_header_above(c("",
                     "Optimal Bandwidth" = 2, 
                     "[10, 150]" = 1, 
                     "[20, 140]" = 1,
                     "[30, 130]" = 1)) %>%
  kable_styling(latex_options = c("hold_position")) %>%
  kableExtra::footnote(alphabet = "Mean of the dependent variable is 50.1%", threeparttable = T) %>%
  row_spec(2, hline_after = TRUE)) %>% 
    save_kable("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Writing/git/Sesmarias/04.Tables/v1/rdd_men_enslaved_farming_1872.tex")

```

```{r}
women_farmers_slaves <-
    rdd_data(y = clean_1872_NE$women_farmers_slaves, 
             x = clean_1872_NE$coast_dist, 
             cutpoint = 80) 

bw_ik <- rdd_bw_ik(women_farmers_slaves, kernel = "Triangular")

reg_1 <- 
  rdd_reg_lm(women_farmers_slaves, slope = "separate", order = 1, bw = bw_ik) 

reg_2 <- 
  rdd_reg_lm(women_farmers_slaves, slope = "separate", order = 2, bw = bw_ik) 

reg_3 <- 
  rdd_reg_lm(women_farmers_slaves, slope = "separate", order = 1, bw = 70) 

reg_4 <- 
  rdd_reg_lm(women_farmers_slaves, slope = "separate", order = 1, bw = 60) 

reg_5 <- 
  rdd_reg_lm(women_farmers_slaves, slope = "separate", order = 1, bw = 50) 

sub("(\\\\midrule.*?)\\\\midrule", "\\1",
modelsummary(list("(1)" = reg_1, 
                  "(2)" = reg_2,
                  "(3)" = reg_3,
                  "(4)" = reg_4,
                  "(5)" = reg_5), 
             output = 'latex',
             coef_map = c("D" = "Estimate"), 
             gof_omit = 'R2 Adj.|se_type', 
             stars = c('*' = .1, '**' = 0.05, '***' = 0.01 ),
             add_rows = rows_se,
             gof_map = gm,
             escape = FALSE,
             title = "Effects on Proportion of Female Slaves Working in Farming (\\%) \\label{tab:rdd_women_enslaved_farming}") %>%
  add_header_above(c("",
                     "Optimal Bandwidth" = 2, 
                     "[10, 150]" = 1, 
                     "[20, 140]" = 1,
                     "[30, 130]" = 1)) %>%
  kable_styling(latex_options = c("hold_position")) %>%
  kableExtra::footnote(alphabet = "Mean of the dependent variable is 30.1%", threeparttable = T) %>%
  row_spec(2, hline_after = TRUE)) %>% 
    save_kable("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Writing/git/Sesmarias/04.Tables/v1/rdd_women_enslaved_farming_1872.tex")
```

```{r}
domestic_service_slaves <-
    rdd_data(y = clean_1872_NE$domestic_service_slaves, 
             x = clean_1872_NE$coast_dist, 
             cutpoint = 80) 

bw_ik <- rdd_bw_ik(domestic_service_slaves, kernel = "Triangular")

reg_1 <- 
  rdd_reg_lm(domestic_service_slaves, slope = "separate", order = 1, bw = bw_ik) 

reg_2 <- 
  rdd_reg_lm(domestic_service_slaves, slope = "separate", order = 2, bw = bw_ik) 

reg_3 <- 
  rdd_reg_lm(domestic_service_slaves, slope = "separate", order = 1, bw = 70) 

reg_4 <- 
  rdd_reg_lm(domestic_service_slaves, slope = "separate", order = 1, bw = 60) 

reg_5 <- 
  rdd_reg_lm(domestic_service_slaves, slope = "separate", order = 1, bw = 50) 

sub("(\\\\midrule.*?)\\\\midrule", "\\1",
modelsummary(list("(1)" = reg_1, 
                  "(2)" = reg_2,
                  "(3)" = reg_3,
                  "(4)" = reg_4,
                  "(5)" = reg_5), 
             output = 'latex',
             coef_map = c("D" = "Estimate"), 
             gof_omit = 'R2 Adj.|se_type', 
             stars = c('*' = .1, '**' = 0.05, '***' = 0.01 ),
             add_rows = rows_se,
             gof_map = gm,
             escape = FALSE,
             title = "Effects on Proportion of Slaves in Domestic Work (\\%) \\label{tab:rdd_enslaved_domestic}") %>%
  add_header_above(c("",
                     "Optimal Bandwidth" = 2, 
                     "[10, 150]" = 1, 
                     "[20, 140]" = 1,
                     "[30, 130]" = 1)) %>%
  kable_styling(latex_options = c("hold_position")) %>%
  kableExtra::footnote(alphabet = "Mean of the dependent variable is 18.6%", threeparttable = T) %>%
  row_spec(2, hline_after = TRUE)) %>% 
    save_kable("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Writing/git/Sesmarias/04.Tables/v1/rdd_enslaved_domestic_1872.tex")
```

```{r}
domestic_service_slaves_men <-
    rdd_data(y = clean_1872_NE$domestic_service_slaves_men, 
             x = clean_1872_NE$coast_dist, 
             cutpoint = 80) 

bw_ik <- rdd_bw_ik(domestic_service_slaves_men, kernel = "Triangular")

reg_1 <- 
  rdd_reg_lm(domestic_service_slaves_men, slope = "separate", order = 1, bw = bw_ik) 

reg_2 <- 
  rdd_reg_lm(domestic_service_slaves_men, slope = "separate", order = 2, bw = bw_ik) 

reg_3 <- 
  rdd_reg_lm(domestic_service_slaves_men, slope = "separate", order = 1, bw = 70) 

reg_4 <- 
  rdd_reg_lm(domestic_service_slaves_men, slope = "separate", order = 1, bw = 60) 

reg_5 <- 
  rdd_reg_lm(domestic_service_slaves_men, slope = "separate", order = 1, bw = 50) 

sub("(\\\\midrule.*?)\\\\midrule", "\\1",
modelsummary(list("(1)" = reg_1, 
                  "(2)" = reg_2,
                  "(3)" = reg_3,
                  "(4)" = reg_4,
                  "(5)" = reg_5), 
             output = 'latex',
             coef_map = c("D" = "Estimate"), 
             gof_omit = 'R2 Adj.|se_type', 
             stars = c('*' = .1, '**' = 0.05, '***' = 0.01 ),
             add_rows = rows_se,
             gof_map = gm,
             escape = FALSE,
             title = "Effects on Proportion of Male Slaves in Domestic Work (\\%) \\label{tab:rdd_enslaved_domestic_men}") %>%
  add_header_above(c("",
                     "Optimal Bandwidth" = 2, 
                     "[10, 150]" = 1, 
                     "[20, 140]" = 1,
                     "[30, 130]" = 1)) %>%
  kable_styling(latex_options = c("hold_position")) %>%
  kableExtra::footnote(alphabet = "Mean of the dependent variable is 10.7%", threeparttable = T) %>%
  row_spec(2, hline_after = TRUE)) %>% 
    save_kable("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Writing/git/Sesmarias/04.Tables/v1/rdd_enslaved_domestic_men_1872.tex")
```

```{r}
domestic_service_slave_women <-
    rdd_data(y = clean_1872_NE$domestic_service_slave_women, 
             x = clean_1872_NE$coast_dist_seat, 
             cutpoint = 80) 

bw_ik <- rdd_bw_ik(domestic_service_slave_women, kernel = "Triangular")

reg_1 <- 
  rdd_reg_lm(domestic_service_slave_women, slope = "separate", order = 1, bw = bw_ik) 

reg_2 <- 
  rdd_reg_lm(domestic_service_slave_women, slope = "separate", order = 2, bw = bw_ik) 

reg_3 <- 
  rdd_reg_lm(domestic_service_slave_women, slope = "separate", order = 1, bw = 70) 

reg_4 <- 
  rdd_reg_lm(domestic_service_slave_women, slope = "separate", order = 1, bw = 60) 

reg_5 <- 
  rdd_reg_lm(domestic_service_slave_women, slope = "separate", order = 1, bw = 50) 

sub("(\\\\midrule.*?)\\\\midrule", "\\1",
modelsummary(list("(1)" = reg_1, 
                  "(2)" = reg_2,
                  "(3)" = reg_3,
                  "(4)" = reg_4,
                  "(5)" = reg_5), 
             output = 'latex',
             coef_map = c("D" = "Estimate"), 
             gof_omit = 'R2 Adj.|se_type', 
             stars = c('*' = .1, '**' = 0.05, '***' = 0.01 ),
             add_rows = rows_se,
             gof_map = gm,
             escape = FALSE,
             title = "Effects on Proportion of Female Slaves in Domestic Work (\\%) \\label{tab:rdd_enslaved_domestic_women}") %>%
  add_header_above(c("",
                     "Optimal Bandwidth" = 2, 
                     "[10, 150]" = 1, 
                     "[20, 140]" = 1,
                     "[30, 130]" = 1)) %>%
  kable_styling(latex_options = c("hold_position")) %>%
  kableExtra::footnote(alphabet = "Mean of the dependent variable is 27.3%", threeparttable = T) %>%
  row_spec(2, hline_after = TRUE)) %>% 
    save_kable("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Writing/git/Sesmarias/04.Tables/v1/rdd_enslaved_domestic_women_1872.tex")
```

```{r}
farmers <-
    rdd_data(y = clean_1872_NE$farmers, 
             x = clean_1872_NE$coast_dist, 
             cutpoint = 80) 

bw_ik <- rdd_bw_ik(farmers, kernel = "Triangular")

reg_1 <- 
  rdd_reg_lm(farmers, slope = "separate", order = 1, bw = bw_ik) 

reg_2 <- 
  rdd_reg_lm(farmers, slope = "separate", order = 2, bw = bw_ik) 

reg_3 <- 
  rdd_reg_lm(farmers, slope = "separate", order = 1, bw = 70) 

reg_4 <- 
  rdd_reg_lm(farmers, slope = "separate", order = 1, bw = 60) 

reg_5 <- 
  rdd_reg_lm(farmers, slope = "separate", order = 1, bw = 50) 

sub("(\\\\midrule.*?)\\\\midrule", "\\1",
modelsummary(list("(1)" = reg_1, 
                  "(2)" = reg_2,
                  "(3)" = reg_3,
                  "(4)" = reg_4,
                  "(5)" = reg_5), 
             output = 'latex',
             coef_map = c("D" = "Estimate"), 
             gof_omit = 'R2 Adj.|se_type', 
             stars = c('*' = .1, '**' = 0.05, '***' = 0.01 ),
             add_rows = rows_se,
             gof_map = gm,
             escape = FALSE,
             title = "Effects on Proportion of Farmers (\\%) \\label{tab:rdd_farmers}") %>%
  add_header_above(c("",
                     "Optimal Bandwidth" = 2, 
                     "[10, 150]" = 1, 
                     "[20, 140]" = 1,
                     "[30, 130]" = 1)) %>%
  kable_styling(latex_options = c("hold_position")) %>%
  kableExtra::footnote(alphabet = "Mean of the dependent variable is 31.4%", threeparttable = T) %>%
  row_spec(2, hline_after = TRUE)) %>% 
    save_kable("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Writing/git/Sesmarias/04.Tables/v1/rdd_farmers_1872.tex")
```

```{r}
literacy <-
    rdd_data(y = clean_1872_NE$SomaDeSOMA_L_Almas, 
             x = clean_1872_NE$coast_dist, 
             cutpoint = 80) 

bw_ik <- rdd_bw_ik(literacy, kernel = "Triangular")

reg_1 <- 
  rdd_reg_lm(literacy, slope = "separate", order = 1, bw = bw_ik) 

reg_2 <- 
  rdd_reg_lm(literacy, slope = "separate", order = 2, bw = bw_ik) 

reg_3 <- 
  rdd_reg_lm(literacy, slope = "separate", order = 1, bw = 70) 

reg_4 <- 
  rdd_reg_lm(literacy, slope = "separate", order = 1, bw = 60) 

reg_5 <- 
  rdd_reg_lm(literacy, slope = "separate", order = 1, bw = 50) 

sub("(\\\\midrule.*?)\\\\midrule", "\\1",
modelsummary(list("(1)" = reg_1, 
                  "(2)" = reg_2,
                  "(3)" = reg_3,
                  "(4)" = reg_4,
                  "(5)" = reg_5), 
             output = 'latex',
             coef_map = c("D" = "Estimate"), 
             gof_omit = 'R2 Adj.|se_type', 
             stars = c('*' = .1, '**' = 0.05, '***' = 0.01 ),
             add_rows = rows_se,
             gof_map = gm,
             escape = FALSE,
             title = "Effects on Literacy Rate (\\%) \\label{tab:rdd_literacy_1872}") %>%
  add_header_above(c("",
                     "Optimal Bandwidth" = 2, 
                     "[10, 150]" = 1, 
                     "[20, 140]" = 1,
                     "[30, 130]" = 1)) %>%
  kable_styling(latex_options = c("hold_position")) %>%
  kableExtra::footnote(alphabet = "Mean of the dependent variable is 26.3%", threeparttable = T) %>%
  row_spec(2, hline_after = TRUE)) %>% 
    save_kable("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Writing/git/Sesmarias/04.Tables/v1/rdd_literacy_1872.tex")
```

```{r}
women_farmers_prop <-
    rdd_data(y = clean_1872_NE$women_farmers_prop, 
             x = clean_1872_NE$coast_dist, 
             cutpoint = 80) 

bw_ik <- rdd_bw_ik(women_farmers_prop, kernel = "Triangular")

reg_1 <- 
  rdd_reg_lm(women_farmers_prop, slope = "separate", order = 1, bw = bw_ik) 

reg_2 <- 
  rdd_reg_lm(women_farmers_prop, slope = "separate", order = 2, bw = bw_ik) 

reg_3 <- 
  rdd_reg_lm(women_farmers_prop, slope = "separate", order = 1, bw = 70) 

reg_4 <- 
  rdd_reg_lm(women_farmers_prop, slope = "separate", order = 1, bw = 60) 

reg_5 <- 
  rdd_reg_lm(women_farmers_prop, slope = "separate", order = 1, bw = 50) 
```

```{r}
free_blacks_slave_ratio <-
    rdd_data(y = 100*clean_1872_NE$free_blacks_slave_ratio, 
             x = clean_1872_NE$coast_dist, 
             cutpoint = 80) 

bw_ik <- rdd_bw_ik(free_blacks_slave_ratio, kernel = "Triangular")

reg_1 <- 
  rdd_reg_lm(free_blacks_slave_ratio, slope = "separate", order = 1, bw = bw_ik) 

reg_2 <- 
  rdd_reg_lm(free_blacks_slave_ratio, slope = "separate", order = 2, bw = bw_ik) 

reg_3 <- 
  rdd_reg_lm(free_blacks_slave_ratio, slope = "separate", order = 1, bw = 70) 

reg_4 <- 
  rdd_reg_lm(free_blacks_slave_ratio, slope = "separate", order = 1, bw = 60) 

reg_5 <- 
  rdd_reg_lm(free_blacks_slave_ratio, slope = "separate", order = 1, bw = 50) 
```

# Checking effects of the 1701 Royal Decree banning livestock from 10 leagues from the coast

```{r}
clean_1872$pasture_post_1700 <- ifelse(clean_1872$sesmarias_presence_1700 == 1 & clean_1872$pasture == 1, 1, 0)
clean_1872$pasture_pre_1700 <- ifelse(clean_1872$sesmarias_presence_1700 == 0 & clean_1872$pasture == 1, 1, 0)
clean_1872_NE <- subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "MG" , "SP"))

# Any land grants:
## Post-1700
ggplot(clean_1872_NE, 
       aes(x = coast_dist, y = free_slave, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm") +
    geom_vline(xintercept = 66.6, color = "red") +
  labs(x = "Distance to Coast", y = "Any Land Grants Post 1701", title = "Any Land Grants - Linear",
       color = "Within 66km of the Coast") +
  scale_color_discrete(labels=c('No', 'Yes')) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/rdd_any_grants_1700_orderone.png")

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = sesmarias_presence_1700, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm", formula = y ~ x + I(x^2)) +
    geom_vline(xintercept = 66.6, color = "red") +
  labs(x = "Distance to Coast", y = "Any Land Grants Post 1701", title = "Any Land Grants - Quadratic",
       color = "Within 66km of the Coast") +
  scale_color_discrete(labels=c('No', 'Yes')) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/rdd_any_grants_1700_ordertwo.png")

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = sesmarias_presence_1700, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "loess") +
    geom_vline(xintercept = 66.6, color = "red") +
  labs(x = "Distance to Coast", y = "Any Land Grants Post 1701", title = "Any Land Grants - Locally Smooth",
       color = "Within 66km of the Coast") +
  scale_color_discrete(labels=c('No', 'Yes')) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/rdd_any_grants_1700_loess.png")

# Grants Pre 1700

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = sesmarias_presence_1600, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm") +
    geom_vline(xintercept = 66.6, color = "red") +
  labs(x = "Distance to Coast", y = "Any Land Grants Pre 1701", title = "Any Land Grants - Linear",
       color = "Within 66km of the Coast") +
  scale_color_discrete(labels=c('No', 'Yes')) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/rdd_any_grants_1600_orderone.png")

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = sesmarias_presence_1600, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm", formula = y ~ x + I(x^2)) +
    geom_vline(xintercept = 66.6, color = "red") +
labs(x = "Distance to Coast", y = "Any Land Grants Pre 1701", title = "Any Land Grants - Quadratic",
       color = "Within 66km of the Coast") +
  scale_color_discrete(labels=c('No', 'Yes')) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/rdd_any_grants_1600_ordertwo.png")

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = sesmarias_presence_1600, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "loess") +
    geom_vline(xintercept = 66.6, color = "red") +
  labs(x = "Distance to Coast", y = "Any Land Grants Pre 1701", title = "Any Land Grants - Locally Smooth",
       color = "Within 66km of the Coast") +
  scale_color_discrete(labels=c('No', 'Yes')) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/rdd_any_grants_1600_loess.png")


# Pasture Post 1700 Land Grants linear vs. quadratic

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = pasture_post_1700, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm") +
    geom_vline(xintercept = 66.6, color = "red") +
  labs(x = "Distance to Coast", y = "Any Land Grants Pre 1701", title = "Livestock Land Grants - Linear",
       color = "Within 66km of the Coast") +
  scale_color_discrete(labels=c('No', 'Yes')) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/rdd_livestock_grants_1700_orderone.png")

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = pasture_post_1700, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm", formula = y ~ x + I(x^2)) +
    geom_vline(xintercept = 66.6, color = "red") +
  labs(x = "Distance to Coast", y = "Any Land Grants Pre 1701", title = "Livestock Land Grants - Quadratic",
       color = "Within 66km of the Coast") +
  scale_color_discrete(labels=c('No', 'Yes')) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/rdd_livestock_grants_1700_ordertwo.png")

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = pasture_post_1700, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "loess") +
    geom_vline(xintercept = 66.6, color = "red") +
  labs(x = "Distance to Coast", y = "Any Land Grants Pre 1701", 
       title = "Livestock Land Grants - Locally Smooth",
       color = "Within 66km of the Coast") +
  scale_color_discrete(labels=c('No', 'Yes')) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/rdd_livestock_grants_1700_loess.png")

# Pasture Workers, linear vs. quadratic

ggplot(clean_1872_NE, 
       aes(x = coast_dist, y = pasture_workers, color = factor(ten_leagues))) +
    geom_point() +
    #stat_summary_bin(fun.y='mean', bins=50,
    #                color='orange', size=2, geom='point') +
    geom_smooth(method = "lm") +
    geom_vline(xintercept = 66.6, color = "red") +
  labs(x = "Distance to Coast", y = "Workers in Livestock Creation (% of Total)", 
       title = "% of Workforce on Livestock Creation - Linear",
       color = "Within 66km of the Coast") +
  scale_color_discrete(labels=c('No', 'Yes')) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/rdd_livestock_workers_1872_orderone.png")

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = pasture_workers, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm", formula = y ~ x + I(x^2)) +
    geom_vline(xintercept = 66.6, color = "red") +
  labs(x = "Distance to Coast", y = "Workers in Livestock Creation (% of Total)", 
       title = "% of Workforce on Livestock Creation - Quadratic",
       color = "Within 66km of the Coast") +
  scale_color_discrete(labels=c('No', 'Yes')) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/rdd_livestock_workers_1872_ordertwo.png")

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = pasture_workers, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "loess") +
    geom_vline(xintercept = 66.6, color = "red") +
  labs(x = "Distance to Coast", y = "Workers in Livestock Creation (% of Total)", 
       title = "% of Workforce on Livestock Creation - Locally Smooth",
       color = "Within 66km of the Coast") +
  scale_color_discrete(labels=c('No', 'Yes')) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/rdd_livestock_workers_1872_loess.png")


# Pasture Workers, now including Bahia

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL","BA")), 
       aes(x = coast_dist, y = pasture_workers, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm") +
    geom_vline(xintercept = 66.6, color = "red") +
  labs(x = "Distance to Coast", y = "Workers in Livestock Creation (% of Total)", 
       title = "% of Workforce on Livestock Creation - Linear + Bahia",
       color = "Within 66km of the Coast") +
  scale_color_discrete(labels=c('No', 'Yes')) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/rdd_BA_livestock_workers_1872_orderone.png")

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "BA")), 
       aes(x = coast_dist, y = pasture_workers, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm", formula = y ~ x + I(x^2)) +
    geom_vline(xintercept = 66.6, color = "red") +
  labs(x = "Distance to Coast", y = "Workers in Livestock Creation (% of Total)", 
       title = "% of Workforce on Livestock Creation - Quadratic + Bahia",
       color = "Within 66km of the Coast") +
  scale_color_discrete(labels=c('No', 'Yes')) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/rdd_BA_livestock_workers_1872_ordertwo.png")

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "BA")), 
       aes(x = coast_dist, y = pasture_workers, color = factor(ten_leagues))) +
    geom_point() +
    #stat_summary_bin(fun.y='mean', bins=20,
    #                color='orange', size=2, geom='point') +
    geom_smooth(method = "loess") +
    geom_vline(xintercept = 66.6, color = "red") +
  labs(x = "Distance to Coast", y = "Workers in Livestock Creation (% of Total)", 
       title = "% of Workforce on Livestock Creation - Locally Smooth + Bahia",
       color = "Within 66km of the Coast") +
  scale_color_discrete(labels=c('No', 'Yes')) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/rdd_BA_livestock_workers_1872_loess.png")

# Farming in general:

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = farmers, color = factor(ten_leagues))) +
    geom_point() +
    #stat_summary_bin(fun.y='mean', bins=20,
    #                color='orange', size=2, geom='point') +
    geom_smooth(method = "lm") +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()

ggplot(clean_1872_NE, 
       aes(x = coast_dist, y = farmers, color = factor(ten_leagues))) +
    geom_point() +
    #stat_summary_bin(fun.y='mean', bins=20,
    #                color='orange', size=2, geom='point') +
    geom_smooth(method = "lm", formula = y ~ x + I(x^2)) +
    geom_vline(xintercept = 80, color = "red") +
  theme_bw()

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = farmers, color = factor(ten_leagues))) +
    geom_point() +
    #stat_summary_bin(fun.y='mean', bins=20,
    #                color='orange', size=2, geom='point') +
    geom_smooth(method = "loess") +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()


# Literacy?

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = literacy_rate, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm") +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = literacy_rate, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm", formula = y ~ x + I(x^2)) +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = literacy_rate, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "loess") +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()

# Total Population

ggplot(clean_1872_NE, 
       aes(x = coast_dist, y = log(SomaDeSOMA_G_Almas), color = factor(ten_leagues))) +
    geom_point() +
    #stat_summary_bin(fun.y='mean', bins=50,
    #                color='orange', size=2, geom='point') +
    geom_smooth(method = "lm") +
    geom_vline(xintercept = 66.6, color = "red") +
  labs(x = "Distance to Coast", y = "Ln(Total Population)", 
       title = "Ln(Total Population) - Linear",
       color = "Within 66km of the Coast") +
  scale_color_discrete(labels=c('No', 'Yes')) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/rdd_totalpop_1872_orderone.png")

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = log(SomaDeSOMA_G_Almas), color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm", formula = y ~ x + I(x^2)) +
    geom_vline(xintercept = 66.6, color = "red") +
  labs(x = "Distance to Coast", y = "Ln(Total Population)", 
       title = "Ln(Total Population) - Quadratic",
       color = "Within 66km of the Coast") +
  scale_color_discrete(labels=c('No', 'Yes')) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/rdd_totalpop_1872_ordertwo.png")


ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = log(SomaDeSOMA_G_Almas), color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "loess") +
    geom_vline(xintercept = 66.6, color = "red") +
  labs(x = "Distance to Coast", y = "Ln(Total Population)", 
       title = "Ln(Total Population) - Locally Smooth",
       color = "Within 66km of the Coast") +
  scale_color_discrete(labels=c('No', 'Yes')) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/rdd_totalpop_1872_loess.png")

# Slaves to Free Population Ratio:

# Blacks to Slaves Slavery Ratio:

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = free_blacks_slave_ratio, color = factor(ten_leagues))) +
    geom_point() +
    #stat_summary_bin(fun.y='mean', bins=20,
    #                color='orange', size=2, geom='point') +
    geom_smooth(method = "lm") +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = free_blacks_slave_ratio, color = factor(ten_leagues))) +
    geom_point() +
    #stat_summary_bin(fun.y='mean', bins=20,
    #                color='orange', size=2, geom='point') +
    geom_smooth(method = "lm", formula = y ~ x + I(x^2)) +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = free_blacks_slave_ratio, color = factor(ten_leagues))) +
    geom_point() +
    #stat_summary_bin(fun.y='mean', bins=20,
    #                color='orange', size=2, geom='point') +
    geom_smooth(method = "loess") +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()
```

```{r}
clean_1872_NE$past_ten_leagues <- ifelse(clean_1872_NE$coast_dist > 80 , 1 ,0)

# Other

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = pasture_post_1700, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm", formula = y ~ x + I(x^2)) +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()

ggplot(subset(clean_1872_NE, coast_dist < 120),
       aes(x = coast_dist, y = free_slave, color = factor(ten_leagues))) +
    geom_point() +
    #stat_summary_bin(fun.y='mean', bins=100,
    #                color='orange', size=2, geom='point') +
    geom_smooth(method = "lm") +
    geom_vline(xintercept = 80, color = "red") +
  theme_bw()

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = pasture_workers, color = factor(ten_leagues))) +
    geom_point() +
    #stat_summary_bin(fun.y='mean', bins=20,
    #                color='orange', size=2, geom='point') +
    geom_smooth(method = "lm", formula = y ~ x + I(x^2)) +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = pasture_post_1700, color = factor(ten_leagues))) +
    geom_point() +
    #stat_summary_bin(fun.y='mean', bins=20,
    #                color='orange', size=2, geom='point') +
    geom_smooth(method = "lm", formula = y ~ x + I(x^2)) +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "BA")), 
       aes(x = coast_dist, y = pasture_workers, color = factor(ten_leagues))) +
    geom_point() +
    #stat_summary_bin(fun.y='mean', bins=100,
    #                color='orange', size=2, geom='point') +
    geom_smooth(method = "lm") +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()

clean_1872_NE_donut <- subset(clean_1872_NE, coast_dist < 46.6 | coast_dist > 76.6)

clean_1872_donut <- subset(clean_1872, coast_dist < 46.6 | coast_dist > 76.6)

# Issue is that league can be 4.8, or 6.6, but even based on the other source 8

summary(
rdrobust(x = clean_1872_NE$coast_dist, y = clean_1872_NE$pasture_workers,
                 c = 80, p = 1))

summary(
rdrobust(x = clean_1872_NE$coast_dist, y = clean_1872_NE$pasture_workers,
          kernel = "triangular", p = 2, bwselect = "mserd",
                 c = 80))

summary(
rdrobust(x = clean_1872_NE_donut$coast_dist, y = clean_1872_NE_donut$pasture,
                 c = 80, p = 1))

rdplot(x = clean_1872_NE$coast_dist, y = clean_1872_NE$pasture_post_1700, 
       binselect="es", ci=95, 
       c = 66.6, p = 2)

rdplot(x = clean_1872_NE$coast_dist, y = clean_1872_NE$pasture_workers, 
       binselect="es", ci=95, 
       c = 80, p = 1)

rdplot(x = clean_1872$coast_dist, y = clean_1872$pasture_workers, 
       binselect="es", ci=95, 
       c = 66.6, p = 2)

# Normal RD no fancy stuff:

pasture_workers <-
rdd_data(y = clean_1872_NE$free_slave, 
         x = clean_1872_NE$coast_dist, 
         cutpoint = 60) 

pasture_workers %>% 
  rdd_reg_lm(slope = "separate", order = 1) %>% 
  summary()

pasture_grants <-
rdd_data(y = clean_1872_NE$pasture_post_1700, 
         x = clean_1872_NE$coast_dist, 
         cutpoint = 80) 

pasture_grants %>% 
  rdd_reg_lm(slope = "separate", order = 2) %>% 
  summary()



# Entirety of Brazil - only looking at ranching workers

summary(
rdrobust(x = clean_1872_donut$coast_dist, y = clean_1872_donut$free_slave,
                 c = 66.6, p = 2))

summary(
rdrobust(x = clean_1872_NE$coast_dist, y = clean_1872_NE$free_slave,
                 c = 66.6, p = 2))

rdplot(x = clean_1872_NE$coast_dist, y = clean_1872_NE$free_slave, 
       binselect="es", ci=95, 
       #covs = factor(clean_1872_donut$abbrev_state), 
       c = 80, p = 2)

#rdplot(x = clean_1872_donut$coast_dist, y = clean_1872_donut$pasture, 
#       c = 66.6, p = 2)



ggplot(clean_1872_donut, 
       aes(x = coast_dist, y = free_slave, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=100,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm") +
    annotate("rect", fill = "red", alpha = 0.5, 
           xmin = 46.6, xmax = 76.6,
           ymin = -Inf, ymax = Inf) +
  theme_bw()

rdd_data(y = clean_1872_NE$pasture_post_1700, 
         x = clean_1872_NE$coast_dist, 
         cutpoint = 66.6) %>% 
  rdd_reg_lm(slope = "separate") %>% 
  summary()

rdd_data(y = clean_1872_NE$pasture_workers, 
         x = clean_1872_NE$coast_dist, 
         cutpoint = 80) %>% 
  rdd_reg_lm(slope = "separate") %>% 
  summary()

library(data.table)
dt = fread("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research Data/Brazil/IPUMS/1980/ipums_1980.csv.gz")
```

### RDD - Coastal effects:

```{r}
# Any land grants:
ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = sesmarias_presence_1700, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm") +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = sesmarias_presence_1700, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm", formula = y ~ x + I(x^2)) +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()

# Pasture Land Grants linear vs. quadratic

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = pasture_post_1700, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm") +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = pasture_post_1700, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm", formula = y ~ x + I(x^2)) +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()

# Very specific on raising cattle 

ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = cattle_raising_post_1701, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm") +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()


ggplot(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
       aes(x = coast_dist, y = cattle_raising_post_1701, color = factor(ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm", formula = y ~ x + I(x^2)) +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()

```

## For 2010:
```{r}
mun_2010_NE$within_ten_leagues <- ifelse(mun_2010_NE$coast_dist < 80, 1, 0)

ggplot(mun_2010_NE, 
       aes(x = coast_dist, y = frac_15, color = factor(within_ten_leagues))) +
    geom_point() +
    #stat_summary_bin(fun.y='mean', bins=50,
    #                color='orange', size=2, geom='point') +
    geom_smooth(method = "loess") +
    geom_vline(xintercept = 80, color = "red") +
  theme_bw()

ggplot(mun_2010_NE, 
       aes(x = coast_dist, y = sugarcane, color = factor(within_ten_leagues))) +
    geom_point() +
    #stat_summary_bin(fun.y='mean', bins=50,
    #                color='orange', size=2, geom='point') +
    geom_smooth(method = "loess") +
    geom_vline(xintercept = 80, color = "red") +
  theme_bw()

ggplot(subset(mun_2010_NE, coast_dist < 150),
       aes(x = coast_dist, y = cattle_raising_post_1701, color = factor(within_ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "loess") +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()

ggplot(subset(mun_2010_NE, coast_dist < 150),
       aes(x = coast_dist, y = sugarcane, color = factor(within_ten_leagues))) +
    geom_point() +
    #stat_summary_bin(fun.y='mean', bins=50,
    #                color='orange', size=2, geom='point') +
    geom_smooth(method = "loess") +
    geom_vline(xintercept = 80, color = "red") +
  theme_bw()

ggplot(subset(mun_2010_NE, coast_dist < 150),
       aes(x = coast_dist, y = frac_15, color = factor(within_ten_leagues))) +
    #geom_point() +
    stat_summary_bin(fun.y='mean', bins=50,
                    color='orange', size=2, geom='point') +
    geom_smooth(method = "lm") +
    geom_vline(xintercept = 66.6, color = "red") +
  theme_bw()
```

# Merging with the 1872 'microdata' and running the same plots:

```{r}
clean_1872_nag <- st_drop_geometry(clean_1872) %>% dplyr::select(-contains("Soma"))

labor_microcensus_1872 <-
  read.csv("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research Data/Brazil/Census 1872/Microdata/labor_municipality.csv")

labor_microcensus_1872 <- merge(labor_microcensus_1872, clean_1872_nag, 
                                by = c("MunicId", "ProvId"))

labor_microcensus_1872_NE <- subset(labor_microcensus_1872, 
                                    abbrev_state %in% c("PB", "PE", "RN", "AL"))

labor_microcensus_1872_NE$livestock_creator <-
  ifelse(labor_microcensus_1872_NE$CAT_T8 == 139, 1, 0)

labor_microcensus_1872_NE$farmer <-
  ifelse(labor_microcensus_1872_NE$CAT_T8 == 138, 1, 0)

test <- feols(livestock_creator ~ ten_leagues| 
              abbrev_state,
              data = labor_microcensus_1872_NE, 
              cluster = ~MunicId)

test_farmer <-
  feols(farmer ~ ten_leagues| 
              abbrev_state,
              data = labor_microcensus_1872_NE, 
              cluster = ~MunicId)

labor_microcensus_1872_NE$past_ten_leagues <- 
  ifelse(labor_microcensus_1872_NE$coast_dist > 66.6 , 1 ,0)

test_rdd <-
  feols(livestock_creator ~ past_ten_leagues + I(coast_dist - 66.6) + past_ten_leagues:I(coast_dist - 66.6)| 
          abbrev_state,
        data = labor_microcensus_1872_NE, 
        cluster = ~MunicId)

test_rdd_2 <-
  feols(livestock_creator ~ past_ten_leagues + I(coast_dist - 66.6) + past_ten_leagues:I(coast_dist - 66.6)| 
          abbrev_state,
        data = subset(labor_microcensus_1872_NE, coast_dist < 120),
        cluster = ~MunicId)

test_rdd_3 <-
  feols(livestock_creator ~ past_ten_leagues + I(coast_dist - 66.6) + past_ten_leagues:I(coast_dist - 66.6)| 
          abbrev_state,
        data = subset(labor_microcensus_1872_NE, coast_dist < 100),
        cluster = ~MunicId)


summary(test_farmer)

test_2 <- 
  feols(pasture_workers ~ ten_leagues + I(coast_dist - 66.6) + ten_leagues:I(coast_dist - 66.6)|
          abbrev_state,
        data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")))

summary(test_rdd)
summary(test_2)

```

# Some other Stuff

```{r}
ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
          fill = "lightblue") +
  geom_sf(data = sesmarias_pts, size = 1.5, 
          color = "black",
          shape = 21, fill = "red") +
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(title = "Georeferenced Land Grants") +
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/descriptive_map.png")
```

### Plotting by Type of Request

```{r}
ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
          fill = "lightblue") +
  geom_sf(data = subset(sesmarias_pts, pasture == 1), 
          size = 1.5, color = "black", 
          shape = 22, 
          aes(fill = "pasture")) +
  geom_sf(data = subset(sesmarias_pts, sugar == 1), 
          size = 1.5, color = "black",
          shape = 21, 
         aes(fill = "sugar")) +
  scale_fill_manual("Economic Activity:", 
                    labels =  c("Pasture", "Sugarcane"),
                    values = c("grey", "red")) + 
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(title = "Sugarcane Plantations vs. Ranching") +
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/sugar_pasture.png")
```

```{r}
ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
          fill = "lightblue") +
  geom_sf(data = subset(sesmarias_pts, discovery == 0), 
          size = 1.5, color = "black", 
          shape = 22, 
          aes(fill = "No Discovery")) +
  geom_sf(data = subset(sesmarias_pts, discovery == 1), 
          size = 1.5, color = "black",
          shape = 21, 
          aes(fill = "Discovery")) +
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(title = "Claimed Discovery of the Land") +
  scale_fill_manual("Claimed Discovery of Land:", 
                    labels =  c("No", "Yes"),
                    values = c("grey", "red")) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/discovery.png")
```

Interact the discovery with the year one:

```{r}
# sesmarias_pts <- subset(sesmarias_pts, reference != "PE0276")
sesmarias_pts$post_1700 <- ifelse(sesmarias_pts$Year >= 1700, 1, 0)
sesmarias_pts$interact <- interaction(sesmarias_pts$discovery, sesmarias_pts$post_1700)

ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
          fill = "lightblue") +
  geom_sf(data = subset(sesmarias_pts, is.na(interact) == F),
          size = 1.5, color = "black", 
          shape = 21, 
          aes(fill = interact)) +
  #geom_sf(data = subset(sesmarias_pts, discovery == 1 & Year >= 1700), 
  #        size = 1.5, color = "black",
  #        shape = 21, fill = "red") +
  #geom_sf(data = subset(sesmarias_pts, discovery == 1 & Year < 1700), 
  #        size = 1.5, color = "black",
  #        shape = 21, fill = "green") +
  scale_fill_manual("Claimed Discovery of Land - Year:", 
                    labels =  c("No - Pre 1700", "Yes - Pre 1700", 
                                "No - Post 1700", "Yes - Post 1700"),
                    values = c("grey", "red", "green", "purple")) + 
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(title = "Claimed Discovery - By Year Split") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/discovery_year.png")
```

```{r}
ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
          fill = "lightblue") +
  geom_sf(data = subset(sesmarias_pts, no_land == 0), 
          size = 1.5, color = "black", 
          shape = 22, fill = "gray") +
  geom_sf(data = subset(sesmarias_pts, no_land == 1 & Year >= 1700), 
          size = 1.5, color = "black",
          shape = 21, fill = "red") +
  geom_sf(data = subset(sesmarias_pts, no_land == 1 & Year < 1700), 
          size = 1.5, color = "black",
          shape = 21, fill = "green") +
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(title = "Claimed Not Owning Any Land") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
```

Interact the discovery with the no land one:

```{r}
ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
          fill = "lightblue") +
  geom_sf(data = subset(sesmarias_pts, no_land == 0),
          size = 1.5, color = "black", 
          shape = 22, 
          aes(fill = "No")) +
  geom_sf(data = subset(sesmarias_pts, no_land == 1), 
          size = 1.5, color = "black",
          shape = 21, 
          aes(fill = "Yes")) +
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(title = "Claimed Not Owning Any Land") +
  scale_fill_manual("Claimed Not Owning Land:", 
                    labels =  c("No", "Yes"),
                    values = c("grey", "red")) + 
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/no_land.png")
```

```{r, eval = FALSE}
sesmarias_pts <- cbind(sesmarias_pts, st_coordinates(sesmarias_pts))
sesmarias_pts$year_2 <- as.Date(as.character(sesmarias_pts$Year), format = "%Y")

test = 
ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
          fill = "lightblue") +
  geom_point(data = subset(sesmarias_pts, Year %in% seq(1500,1900,1)),
             aes(x = X, y = Y, group = interaction(reference, Year)), 
          size = 1.5, color = "black",
          shape = 21, fill = "red") +
  transition_time(year_2) +
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(title = "Claimed Not Owning Any Land") +
  theme_bw() +
  labs(title = "Year: {frame_time}") +
  ease_aes('linear') +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5)) +
  shadow_mark()

p <- animate(test, duration = 20, fps = 5)
anim_save("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/year_distribution.gif", animation = p)
```

```{r}
ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
          fill = "lightblue") +
  geom_sf(data = subset(sesmarias_pts, Year >= 1700), size = 1.5, color = "black", 
          shape = 22, fill = "gray") +
  geom_sf(data = subset(sesmarias_pts, Year < 1700), size = 1.5, color = "black",
          shape = 21, fill = "red") +
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(title = "Pre and Post 1700") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/year_distribution.png")
```

### Other

```{r}
ggplot(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "CE")), 
       aes(x = sugarcane, y = free_slave)) +
  geom_point(color = "black", fill = "red") +
  geom_smooth(method='lm') + 
  labs(y = "Percentage of Slaves to Total Population (%)", x = "Potential Sugarcane Production",
       title = "Relationship between Slavery and Sugarcane in Northeastern States - Brazil") +
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/sugarcane_slavery.png")

ggplot(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "CE")), 
       aes(x = sugarcane, y = literacy_rate)) +
  geom_point(color = "black", fill = "red") +
  geom_smooth(method='lm') + 
  labs(y = "Literacy Rate (%)", x = "Potential Sugarcane Production",
       title = "Relationship between Sugarcane and Literacy in Northeastern States - Brazil") +
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/sugarcane_literacy.png")

ggplot(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL", "CE")), 
       aes(x = free_slave, y = literacy_rate)) +
  geom_point(color = "black", fill = "red") +
  geom_smooth(method='lm') + 
  labs(y = "Literacy Rate (%)", x = "Percentage of Slaves to Total Population (%)",
       title = "Relationship between Slavery and Literacy in Northeastern States - Brazil") +
  theme_bw() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/02. Graph/slavery_literacy.png")
```

```{r}
ggplot() +
  geom_sf(data = mun_2010, fill = "white") +
  geom_sf(data = subset(mun_2010, abbrev_state %in% c("PB", "PE", "RN", "AL")), fill = "lightblue") +
  geom_sf(data = sesmarias_pts, size = 0.25, color = "red") +
  coord_sf(ylim = c(-2,-15), xlim = c(-34,-45), expand = FALSE) + 
  theme_bw()
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/municipalities_2010.png")
```

```{r, eval = FALSE}
grid <- 
  st_sfc(
  st_make_grid(subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")),
               cellsize = .1,
               crs = st_crs(clean_1872)))

grid = grid[subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL"))]

# grid <- st_intersection(grid, subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")))

ggplot() +
  #geom_sf(data = subset(clean_1872, abbrev_state %in% c("PB", "PE", "RN", "AL")), 
  #        fill = "black", color = "white") +
  geom_sf(data = subset(mun_2010, abbrev_state %in% c("PB", "PE", "RN", "AL")), 
          fill = "NA", color = "blue") +
  geom_sf(data = grid, fill = NA)
  
```

# Summary Tables:

```{r}

```

# Regressions (1872):

```{r, results = "asis"}
clean_1872 <- cbind(clean_1872, st_coordinates(st_centroid(clean_1872)))
mun_2010_NE <- cbind(mun_2010_NE, st_coordinates(st_centroid(mun_2010_NE)))
clean_1872$area <- st_area(clean_1872)/(1000^2)

clean_1872$sugarcane_t <- clean_1872$sugarcane/1000
mun_2010_NE$sugarcane_t <- mun_2010_NE$sugarcane/1000

test_1 <- estimatr::lm_robust(sesmarias_presence ~ 
                    sugarcane_t, 
                  fixed_effects = ~abbrev_state, 
                  data = subset(clean_1872,  
                                abbrev_state %in% c("PB", "PE", "RN", "AL")))

test_2 <- estimatr::lm_robust(sesmarias_presence ~ 
                    sugarcane_t +
                    X + Y + 
                    m_slope + m_elevation + river_dist + coast_dist + area, 
                  fixed_effects = ~abbrev_state, 
                  data = subset(clean_1872,  
                                abbrev_state %in% c("PB", "PE", "RN", "AL")))

test_3 <- estimatr::lm_robust(sugar ~ 
                    sugarcane_t, 
                  fixed_effects = ~abbrev_state, 
                  data = subset(clean_1872,  
                                abbrev_state %in% c("PB", "PE", "RN", "AL")))

test_4 <- estimatr::lm_robust(sugar ~ 
                    sugarcane_t +
                    X + Y + 
                    m_slope + m_elevation + river_dist + coast_dist + area, 
                  se = "stata",
                  fixed_effects = ~abbrev_state, 
                  data = subset(clean_1872,  
                                abbrev_state %in% c("PB", "PE", "RN", "AL")))

gm <- tibble::tribble(~raw,        ~clean,          ~fmt,
                      "nobs",      "N",             0,
                      "r.squared", "$R^2$", 2)

rows_se <-  tribble(~term, ~'(1)', ~'(2)', ~'(3)', ~'(4)',
                    'Geographical Controls', '', '\\checkmark', '', '\\checkmark')

attr(rows_se, 'section') <- c('top')
attr(rows_se, 'position') <- c(4,5)

options(modelsummary_format_numeric_latex = "plain")
sub("(\\\\midrule.*?)\\\\midrule", "\\1",           
modelsummary(list("(1)" = test_1, 
                  "(2)" = test_2, 
                  "(3)" = test_3,
                  "(4)" = test_4),
              coef_map = c("sugarcane_t" = 
                             "Maximum Sugarcane Output (Thousand of Tons per hectare)"),
             escape = FALSE,
             gof_map = gm,
             output = 'latex',
             stars = c('*' = .1, '**' = 0.05, '***' = 0.01 ),
             add_rows = rows_se,
             title = "Effects of Potential Sugarcane Output on Land Grants") %>%
  add_header_above(c("",
                     "Any Land Grants" = 2, 
                     "Sugar Land Grants" = 2)) %>%
  kable_styling(latex_options = c("scale_down","hold_position")) %>%
  row_spec(2, hline_after = TRUE)) %>%
  save_kable("~/OneDrive - University of Illinois - Urbana/Research/Projects/Sesmarias Brazil/Tables/sugar_first_stage.tex")


# Interesting one:
summary(lm_robust(farmers_slaves ~ log(sugarcane), 
                  fixed_effects = ~abbrev_state, 
                  data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL"))))

summary(lm_robust(free_slave ~ sesmarias_intensity, 
                  fixed_effects = ~abbrev_state, 
                  data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL"))))
```

# Regressions (2010):

```{r}
ggplot() +
  geom_sf(data = mun_2010, fill = "white") +
  geom_sf(data = mun_2010_NE, 
          aes(fill = sugarcane)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 1, 
          color = "black",
          shape = 21, fill = "red") +
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(fill = "Potential Sugar \n Cane Production") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/sugarcane_production_2010.png")
```
### Map for Land Usage

```{r}
ggplot() +
  geom_sf(data = mun_2010, fill = "white") +
  geom_sf(data = mun_2010_NE, 
          aes(fill = 100*frac_15)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 1, 
          color = "black",
          shape = 21, fill = "red") +
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(fill = "Share Area \nfor Pasture\n(1985)") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/pasture_1985_2010.png")
```

```{r}
ggplot() +
  geom_sf(data = mun_2010, fill = "white") +
  geom_sf(data = mun_2010_NE, 
          aes(fill = 100*frac_20)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 1, 
          color = "black",
          shape = 21, fill = "red") +
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(fill = "Share Area\nSugarcane\n(1985)") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/sugarcane_1985_2010.png")
```

```{r}
ggplot() +
  geom_sf(data = mun_2010, fill = "white") +
  geom_sf(data = mun_2010_NE, 
          aes(fill = 100*(frac_3 + frac_4 + frac_5))) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 1, 
          color = "black",
          shape = 21, fill = "red") +
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(fill = "Share Area\nForest\n(1985)") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/forest_1985_2010.png")
```

```{r}
mun_2010_NE$agriculture_pasture = 
  mun_2010_NE$frac_20 + 
  mun_2010_NE$frac_41 + mun_2010_NE$frac_48 +
  mun_2010_NE$frac_15

ggplot() +
  geom_sf(data = mun_2010, fill = "white") +
  geom_sf(data = mun_2010_NE, 
          aes(fill = 100*agriculture_pasture)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 1, 
          color = "black",
          shape = 21, fill = "red") +
  coord_sf(ylim = c(-4,-12), xlim = c(-34,-42), expand = FALSE) + 
  labs(fill = "Share Area\nAgriculture\nor Pasture\n(1985)") +
  theme_bw() +
  theme(# legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5))
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/agriculture_pasture_1985_2010.png")
```

```{r, results = "asis"}
mun_2010_NE$area <- st_area(mun_2010_NE)/(1000^2)
mun_2010_NE$sugarcane_t <- mun_2010_NE$sugarcane/1000

test_1 <- estimatr::lm_robust(sesmarias_presence ~ 
                    sugarcane_t, 
                  fixed_effects = ~abbrev_state, 
                  data = subset(mun_2010_NE,  
                                abbrev_state %in% c("PB", "PE", "RN", "AL")))

test_2 <- estimatr::lm_robust(sesmarias_presence ~ 
                    sugarcane_t +
                    X + Y + 
                    m_slope + m_elevation + river_dist + coast_dist + area, 
                  fixed_effects = ~abbrev_state, 
                  data = subset(mun_2010_NE,  
                                abbrev_state %in% c("PB", "PE", "RN", "AL")))

test_3 <- estimatr::lm_robust(sugar ~ 
                    sugarcane_t, 
                  fixed_effects = ~abbrev_state, 
                  data = subset(mun_2010_NE,  
                                abbrev_state %in% c("PB", "PE", "RN", "AL")))

test_4 <- estimatr::lm_robust(sugar ~ 
                    sugarcane_t +
                    X + Y + 
                    m_slope + m_elevation + river_dist + coast_dist + area, 
                    fixed_effects = ~abbrev_state, 
                    data = subset(mun_2010_NE,  
                                abbrev_state %in% c("PB", "PE", "RN", "AL")))

sub("(\\\\midrule.*?)\\\\midrule", "\\1",
modelsummary(list("(1)" = test_1, 
                  "(2)" = test_2, 
                  "(3)" = test_3,
                  "(4)" = test_4),
             coef_map = c("sugarcane_t" = 
                             "Maximum Sugarcane Output (Thousand of Tons per hectare)"),
             escape = FALSE,
             gof_map = gm,
             output = 'latex',
             stars = c('*' = .1, '**' = 0.05, '***' = 0.01 ),
             add_rows = rows_se,
             title = "Effects of Potential Sugarcane Output on Land Grants - 2010") %>%
    add_header_above(c("",
                     "Any Land Grants" = 2, 
                     "Sugar Land Grants" = 2)) %>%
  kable_styling(latex_options = c("scale_down","hold_position")) %>%
  row_spec(2, hline_after = TRUE)) %>%
  save_kable("~/OneDrive - University of Illinois - Urbana/Research/Projects/Sesmarias Brazil/Tables/sugar_first_stage_2010.tex")

```

```{r}
summary(
estimatr::lm_robust(frac_15 ~ 
                    sesmarias_presence +
                    X + Y + 
                    m_slope + m_elevation + river_dist + coast_dist + area, 
                  fixed_effects = ~abbrev_state, 
                  data = subset(mun_2010_NE,  
                                abbrev_state %in% c("PB", "PE", "RN", "AL"))))
```

# 2010 Data:

```{r}
race2010 <- read_xlsx("~/OneDrive - University of Illinois - Urbana/Research Data/Brazil/Census 2010/race2010census_clean.xlsx")

gini_2010 <- 
  read.csv("~/OneDrive - University of Illinois - Urbana/Research Data/Brazil/DataSUS/Dados/GINI/ginibr_clean.csv")

gdp_2010 <- read_xlsx("~/OneDrive - University of Illinois - Urbana/Research/Projects/Amazon/gdp/GDP1999-2017.xlsx")

gdp_2010 <- subset(gdp_2010, year == 2010)
colnames(gdp_2010)[4] <- "name_muni"
gdp_2010$name_muni <- tolower(gdp_2010$name_muni)
colnames(gdp_2010)[2] <- "abbrev_state"
gdp_2010$abbrev_state <- toupper(gdp_2010$abbrev_state)

mun_2010_NE$name_muni <- tolower(mun_2010_NE$name_muni)

# Look up the not 1-1 merge but approximating by character stuff

mun_2010_N <- merge(race2010, mun_2010_NE, by = c("code_muni"))
mun_2010_N <- merge(gdp_2010, mun_2010_N, 
                    by = c("abbrev_state", "name_muni"))
```

```{r, eval = FALSE }
ggplot() +
  geom_sf(data = mun_1872, fill = "white") +
  geom_sf(data = subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL")), 
          aes(fill = free_slave)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 0.25, color = "red") +
  coord_sf(ylim = c(-2,-15), xlim = c(-34,-45), expand = FALSE) + 
  labs(fill = "Proportion of Slaves \n to Total Population (%)") +
  theme_bw()

ggplot() +
  geom_sf(data = mun_2010$geom, fill = "white") +
  geom_sf(data = subset(mun_2010_NE,  abbrev_state %in% c("PB", "PE", "RN", "AL", "CE")), 
          aes(fill = Preta)) +
  scale_fill_binned(type = "viridis", n.breaks = 10) + 
  geom_sf(data = sesmarias_pts, size = 0.25, color = "red") +
  coord_sf(ylim = c(-2,-15), xlim = c(-34,-45), expand = FALSE) + 
  theme_bw()
```

# Testing Balance

### 1872

```{r, results = "asis"}
clean_1872$within <- 
  ifelse(clean_1872$sesmarias_presence > 0, 
         "At least 1 Land Grant", 
         "No Land Grants")

summary_1872 <- subset(clean_1872,  abbrev_state %in% c("PB", "PE", "RN", "AL"))

summary_1872 <- 
  summary_1872[c("within",
                 "river_dist",
                 "coast_dist",
                 "m_slope",
                 "m_elevation",
                 "sugarcane",
                 "csi_pre",
                 "csi_post",
                 "SomaDeSOMA_G_Almas",
                 "free_slave", 
                 "gender_disparity",
                 "slave_gender_disparity",
                 "industrial_workers", 
                 "farmers_slaves",
                 "farmers",
                 "men_farmers_prop",
                 "women_farmers_prop",
                 "literacy_rate")]

summary_1872 <- dplyr::rename(summary_1872, 
                              # Geographical:
                              "Distance to Nearest River (km)" = river_dist,
                              "Distance to the Coast (km)" = coast_dist,
                              "Mean Slope (m)" = m_slope,
                              "Mean Elevation (m)" = m_elevation,  
                              # Agricultural:
                              "Potential Sugarcane Output (FAO)" = sugarcane, 
                              "Maximum Calories Pre-1500 (Galor, 2016)" = csi_pre,
                              "Maximum Calories Post-1500 (Galor, 2016)" = csi_post,
                              # Demographics
                              "Total Population" = SomaDeSOMA_G_Almas,
                              "Enslaved Population as Total (%)" = free_slave, 
                              "Ratio of Free Men to Free Women" = gender_disparity,
                              "Ratio of Enslaved Men to Enslaved Women" = slave_gender_disparity,
                              # Labor
                              "Proportion of Industrial Workers (%)" = industrial_workers, 
                              "Proportion of Farmers (%)" = farmers,
                              "Proportion of Enslaved People working in Farming (%)" = farmers_slaves,
                              "Proportion of Free Men Farmers (%)" = men_farmers_prop,
                              "Proportion of Free Women Farmers (%)" = women_farmers_prop,
                              # Human Capital:
                              "Literacy Rate (%)" = literacy_rate)


datasummary_balance(~within, summary_1872, 
                    output = 'latex',
                    title = "Summary Statistics for Municipalities in 1872",
                    align = 'lcccccc',
                    stars = c('*' = .1, '**' = .05, '***' = 0.1)) %>% 
                    # escape = FALSE) %>%
  group_rows("Geographical",1,4) %>%
  group_rows("Agriculture", 5,7) %>%
  group_rows("Demographics", 8,11)  %>%
  group_rows("Labor", 12,16) %>%
  group_rows("Human Capital", 17,17) %>%
  kable_styling(latex_options = c("scale_down","hold_position"), position = "center") %>%
  save_kable("~/OneDrive - University of Illinois - Urbana/Research/Projects/Sesmarias Brazil/Tables/summary_1872.tex")
  
datasummary_balance(~within, summary_1872)
```

### Sesmarias Themselves pre-1700 and post- 1700

```{r, results = "asis"}
sesmarias_pts$within <- 
  ifelse(sesmarias_pts$Year < 1697, 
         "Granted between 1624-1696", 
         "Granted between 1697-1750")

sesmarias_summary <- 
  sesmarias_pts[c("within",
                 "river_dist",
                 "coast_dist",
                 "m_slope",
                 "m_elevation",
                 "sugarcane",
                 "csi_pre",
                 "csi_post")]

sesmarias_summary <- dplyr::rename(sesmarias_summary, 
                              # Geographical:
                              "Distance to Nearest River (km)" = river_dist,
                              "Distance to the Coast (km)" = coast_dist,
                              "Mean Slope (m)" = m_slope,
                              "Mean Elevation (m)" = m_elevation,  
                              # Agricultural:
                              "Potential Sugarcane Output (FAO)" = sugarcane, 
                              "Maximum Calories Pre-1500 (Galor, 2016)" = csi_pre,
                              "Maximum Calories Post-1500 (Galor, 2016)" = csi_post)

datasummary_balance(~within, sesmarias_summary,
                    output = 'latex',
                    title = "Summary Statistics for the Land Grants",
                    align = 'lcccccc',
                    stars = c('*' = .1, '**' = .05, '***' = 0.1),
                    dinm_statistic = "std.error") %>%
    kable_styling(latex_options = c("scale_down","hold_position"), position = "center") %>%
  save_kable("~/OneDrive - University of Illinois - Urbana/Research/Projects/Sesmarias Brazil/Tables/summary_sesmarias.tex")
```

# Regressions

```{r}
summary(lm_robust(Preta ~ sesmarias_presence,
                  fixed_effects = ~abbrev_state,
                  data = mun_2010_N))

summary(lm_robust(Parda ~ sesmarias_presence,
                  fixed_effects = ~abbrev_state,
                  data = mun_2010_N))

summary(lm_robust(Branca ~ sesmarias_presence,
                  fixed_effects = ~abbrev_state,
                  data = mun_2010_N))

summary(lm_robust(sesmarias_presence ~ log(sugarcane+1),
                  fixed_effects = ~abbrev_state,
                  data = mun_2010_N))
```

# Regressions on the land grants themselves

```{r}
sesmarias_pts <- cbind(sesmarias_pts, st_coordinates(st_centroid(sesmarias_pts)))

pre_post_1700 <-
  lm_robust(post_1700 ~ sugarcane +
              X + Y + 
              m_slope + m_elevation + river_dist + coast_dist ,
            data = sesmarias_pts)

pasture <-
  lm_robust(pasture ~ sugarcane +
              X + Y + 
              m_slope + m_elevation + river_dist + coast_dist ,
            data = sesmarias_pts)

discovery <-
  lm_robust(discovery ~ sugarcane +
              X + Y + 
              m_slope + m_elevation + river_dist + coast_dist ,
            data = sesmarias_pts)

no_land <-
  lm_robust(no_land ~ sugarcane +
              X + Y + 
              m_slope + m_elevation + river_dist + coast_dist ,
            data = sesmarias_pts)

```

# Current State

```{r}
ggplot() +
  geom_sf(data = mun_2010, fill = "white") +
  geom_sf(data = subset(mun_2010, abbrev_state %in% c("PB", "PE", "RN", "AL")),
          aes(fill = "Done")) +
  geom_sf(data = subset(mun_2010, abbrev_state %in% c("BA")),
          aes(fill = "Currently Being Georeferenced")) +  
  geom_sf(data = subset(mun_2010, abbrev_state %in% c("PA", "AM")),
          aes(fill = "Georeferenced but contact people")) +  
  geom_sf(data = subset(mun_2010, abbrev_state %in% c("MG", "SP")),
          aes(fill = "Letters in .pdf")) +
  geom_vline(xintercept = -47, color = "red") + 
  labs(fill = "Status") +
  theme_bw() +
  theme(legend.title.align=0.5,
        legend.direction = "vertical")
        #legend.position = "bottom") 
ggsave("/Users/vinicius/Library/CloudStorage/OneDrive-UniversityofIllinois-Urbana/Research/Projects/Sesmarias Brazil/Figures/01. Maps/future_step.png")
```
